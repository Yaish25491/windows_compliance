---
- name: Test CIS role application and validation
  block:
    - name: Create test output directory
      ansible.windows.win_file:
        path: "{{ test_cis_output_dir }}"
        state: directory

    - name: Apply CIS Level 1 hardening in check mode
      ansible.builtin.include_role:
        name: ansible.windows_compliance.windows_server_cis
      vars:
        windows_server_cis_level: level_1
        windows_server_cis_check_mode: true
        windows_server_cis_report_path: "{{ test_cis_output_dir }}\\{{ test_cis_level1_check_report_filename }}"

    - name: Verify CIS Level 1 check report was created
      ansible.windows.win_stat:
        path: "{{ test_cis_output_dir }}\\{{ test_cis_level1_check_report_filename }}"
      register: _cis_level1_check_report

    - name: Assert CIS Level 1 check report exists
      ansible.builtin.assert:
        that:
          - _cis_level1_check_report.stat.exists
          - _cis_level1_check_report.stat.size > 0

    - name: Display test completion message
      ansible.builtin.debug:
        msg: "CIS baseline test completed successfully"

  rescue:
    - name: Cleanup on test failure
      ansible.windows.win_file:
        path: "{{ test_cis_output_dir }}"
        state: absent
      ignore_errors: true

    - name: Fail the test
      ansible.builtin.fail:
        msg: "CIS role integration test failed"

  always:
    - name: Cleanup test directory
      ansible.windows.win_file:
        path: "{{ test_cis_output_dir }}"
        state: absent
      ignore_errors: true