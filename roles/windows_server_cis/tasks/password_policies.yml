---
# CIS Microsoft Windows Server 2022 Benchmark v1.0.0
# Section 1.1: Password Policy Settings
# Simplified Enterprise Implementation for Testing

# =============================================================================
# CIS 1.1.1 - Enforce password history  
# =============================================================================

- name: CIS 1.1.1 | AUDIT | Get current password history setting
  ansible.windows.win_shell: |
    net accounts | Select-String "Length of password history maintained" | ForEach-Object { 
      if ($_ -match "(\d+)") { $matches[1] } else { "0" }
    }
  register: windows_server__cis_1_1_1_current
  changed_when: false
  failed_when: false
  check_mode: false
  tags:
    - cis_1.1.1
    - password_policies
    - level_1
    - audit

- name: CIS 1.1.1 | SCORED | Enforce password history ({{ windows_server__cis_password_history_size }} passwords)
  ansible.windows.win_shell: |
    net accounts /uniquepw:{{ windows_server__cis_password_history_size }}
  register: windows_server__cis_1_1_1_result
  when: 
    - "'1.1.1' not in windows_server__cis_skip_rules"
    - windows_server__cis_1_1_1_current.stdout | trim != windows_server__cis_password_history_size | string
  tags:
    - cis_1.1.1
    - password_policies
    - level_1
    - scored

- name: CIS 1.1.1 | AUDIT | Record compliance result
  ansible.builtin.set_fact:
    windows_server__cis_results: >-
      {{ windows_server__cis_results + [{
        'rule_id': '1.1.1',
        'rule_title': 'Enforce password history',
        'rule_section': 'Password Policy',
        'severity': 'Medium',
        'scored': true,
        'level': 'Level 1',
        'expected_value': windows_server__cis_password_history_size,
        'current_value': windows_server__cis_1_1_1_current.stdout | trim,
        'status': 'PASS' if (windows_server__cis_1_1_1_current.stdout | trim == windows_server__cis_password_history_size | string) else 'FAIL',
        'changed': windows_server__cis_1_1_1_result.changed | default(false),
        'skip_reason': 'User configured skip' if '1.1.1' in windows_server__cis_skip_rules else '',
        'check_mode': ansible_check_mode
      }] }}
    windows_server__cis_failed_controls: >-
      {{ windows_server__cis_failed_controls + ['1.1.1'] 
         if (windows_server__cis_1_1_1_current.stdout | trim != windows_server__cis_password_history_size | string and 
             '1.1.1' not in windows_server__cis_skip_rules) 
         else windows_server__cis_failed_controls }}
    windows_server__cis_skipped_controls: >-
      {{ windows_server__cis_skipped_controls + ['1.1.1'] 
         if '1.1.1' in windows_server__cis_skip_rules 
         else windows_server__cis_skipped_controls }}
  tags:
    - cis_1.1.1
    - password_policies

# =============================================================================
# CIS 1.1.2 - Maximum password age
# =============================================================================

- name: CIS 1.1.2 | AUDIT | Get current maximum password age setting
  ansible.windows.win_shell: |
    net accounts | Select-String "Maximum password age" | ForEach-Object { 
      if ($_ -match "(\d+)") { $matches[1] } else { "42" }
    }
  register: windows_server__cis_1_1_2_current
  changed_when: false
  failed_when: false
  check_mode: false
  tags:
    - cis_1.1.2
    - password_policies
    - level_1
    - audit

- name: CIS 1.1.2 | SCORED | Set maximum password age ({{ windows_server__cis_maximum_password_age }} days)
  ansible.windows.win_shell: |
    net accounts /maxpwage:{{ windows_server__cis_maximum_password_age }}
  register: windows_server__cis_1_1_2_result
  when:
    - "'1.1.2' not in windows_server__cis_skip_rules"
    - windows_server__cis_1_1_2_current.stdout | trim != windows_server__cis_maximum_password_age | string
    - windows_server__cis_maximum_password_age | int > 0
    - windows_server__cis_maximum_password_age | int <= 365
  tags:
    - cis_1.1.2
    - password_policies
    - level_1
    - scored

- name: CIS 1.1.2 | AUDIT | Record compliance result  
  ansible.builtin.set_fact:
    windows_server__cis_results: >-
      {{ windows_server__cis_results + [{
        'rule_id': '1.1.2',
        'rule_title': 'Maximum password age',
        'rule_section': 'Password Policy',
        'severity': 'Medium',
        'scored': true,
        'level': 'Level 1',
        'expected_value': windows_server__cis_maximum_password_age,
        'current_value': windows_server__cis_1_1_2_current.stdout | trim,
        'status': 'PASS' if (windows_server__cis_1_1_2_current.stdout | trim == windows_server__cis_maximum_password_age | string) else 'FAIL',
        'changed': windows_server__cis_1_1_2_result.changed | default(false),
        'skip_reason': 'User configured skip' if '1.1.2' in windows_server__cis_skip_rules else '',
        'check_mode': ansible_check_mode
      }] }}
    windows_server__cis_failed_controls: >-
      {{ windows_server__cis_failed_controls + ['1.1.2'] 
         if (windows_server__cis_1_1_2_current.stdout | trim != windows_server__cis_maximum_password_age | string and 
             '1.1.2' not in windows_server__cis_skip_rules) 
         else windows_server__cis_failed_controls }}
    windows_server__cis_skipped_controls: >-
      {{ windows_server__cis_skipped_controls + ['1.1.2'] 
         if '1.1.2' in windows_server__cis_skip_rules 
         else windows_server__cis_skipped_controls }}
  tags:
    - cis_1.1.2
    - password_policies

# =============================================================================
# CIS 1.1.4 - Minimum password length (Simplified for testing)
# =============================================================================

- name: CIS 1.1.4 | AUDIT | Get current minimum password length setting
  ansible.windows.win_shell: |
    net accounts | Select-String "Minimum password length" | ForEach-Object { 
      if ($_ -match "(\d+)") { $matches[1] } else { "0" }
    }
  register: windows_server__cis_1_1_4_current
  changed_when: false
  failed_when: false
  check_mode: false
  tags:
    - cis_1.1.4
    - password_policies
    - level_1
    - audit

- name: CIS 1.1.4 | SCORED | Set minimum password length ({{ windows_server__cis_minimum_password_length }} characters)
  ansible.windows.win_shell: |
    net accounts /minpwlen:{{ windows_server__cis_minimum_password_length }}
  register: windows_server__cis_1_1_4_result
  when:
    - "'1.1.4' not in windows_server__cis_skip_rules"
    - windows_server__cis_1_1_4_current.stdout | trim != windows_server__cis_minimum_password_length | string
    - windows_server__cis_minimum_password_length | int >= 14
  tags:
    - cis_1.1.4
    - password_policies
    - level_1
    - scored

- name: CIS 1.1.4 | AUDIT | Record compliance result
  ansible.builtin.set_fact:
    windows_server__cis_results: >-
      {{ windows_server__cis_results + [{
        'rule_id': '1.1.4',
        'rule_title': 'Minimum password length',
        'rule_section': 'Password Policy',
        'severity': 'High',
        'scored': true,
        'level': 'Level 1',
        'expected_value': windows_server__cis_minimum_password_length,
        'current_value': windows_server__cis_1_1_4_current.stdout | trim,
        'status': 'PASS' if (windows_server__cis_1_1_4_current.stdout | trim == windows_server__cis_minimum_password_length | string) else 'FAIL',
        'changed': windows_server__cis_1_1_4_result.changed | default(false),
        'skip_reason': 'User configured skip' if '1.1.4' in windows_server__cis_skip_rules else '',
        'check_mode': ansible_check_mode
      }] }}
    windows_server__cis_failed_controls: >-
      {{ windows_server__cis_failed_controls + ['1.1.4'] 
         if (windows_server__cis_1_1_4_current.stdout | trim != windows_server__cis_minimum_password_length | string and 
             '1.1.4' not in windows_server__cis_skip_rules) 
         else windows_server__cis_failed_controls }}
    windows_server__cis_skipped_controls: >-
      {{ windows_server__cis_skipped_controls + ['1.1.4'] 
         if '1.1.4' in windows_server__cis_skip_rules 
         else windows_server__cis_skipped_controls }}
  tags:
    - cis_1.1.4
    - password_policies

# =============================================================================
# CIS 1.1.3 - Minimum password age
# =============================================================================

- name: CIS 1.1.3 | AUDIT | Get current minimum password age setting
  ansible.windows.win_shell: |
    net accounts | Select-String "Minimum password age" | ForEach-Object { 
      if ($_ -match "(\d+)") { $matches[1] } else { "0" }
    }
  register: windows_server__cis_1_1_3_current
  changed_when: false
  failed_when: false
  check_mode: false
  tags:
    - cis_1.1.3
    - password_policies
    - level_1
    - audit

- name: CIS 1.1.3 | SCORED | Set minimum password age ({{ windows_server__cis_minimum_password_age }} days)
  ansible.windows.win_shell: |
    net accounts /minpwage:{{ windows_server__cis_minimum_password_age }}
  register: windows_server__cis_1_1_3_result
  when:
    - "'1.1.3' not in windows_server__cis_skip_rules"
    - windows_server__cis_1_1_3_current.stdout | trim != windows_server__cis_minimum_password_age | string
    - windows_server__cis_minimum_password_age | int >= 1
  tags:
    - cis_1.1.3
    - password_policies
    - level_1
    - scored

- name: CIS 1.1.3 | AUDIT | Record compliance result
  ansible.builtin.set_fact:
    windows_server__cis_results: >-
      {{ windows_server__cis_results + [{
        'rule_id': '1.1.3',
        'rule_title': 'Minimum password age',
        'rule_section': 'Password Policy',
        'severity': 'Medium',
        'scored': true,
        'level': 'Level 1',
        'expected_value': windows_server__cis_minimum_password_age,
        'current_value': windows_server__cis_1_1_3_current.stdout | trim,
        'status': 'PASS' if (windows_server__cis_1_1_3_current.stdout | trim == windows_server__cis_minimum_password_age | string) else 'FAIL',
        'changed': windows_server__cis_1_1_3_result.changed | default(false),
        'skip_reason': 'User configured skip' if '1.1.3' in windows_server__cis_skip_rules else '',
        'check_mode': ansible_check_mode
      }] }}
    windows_server__cis_failed_controls: >-
      {{ windows_server__cis_failed_controls + ['1.1.3'] 
         if (windows_server__cis_1_1_3_current.stdout | trim != windows_server__cis_minimum_password_age | string and 
             '1.1.3' not in windows_server__cis_skip_rules) 
         else windows_server__cis_failed_controls }}
    windows_server__cis_skipped_controls: >-
      {{ windows_server__cis_skipped_controls + ['1.1.3'] 
         if '1.1.3' in windows_server__cis_skip_rules 
         else windows_server__cis_skipped_controls }}
  tags:
    - cis_1.1.3
    - password_policies

# =============================================================================
# CIS 1.1.5 - Password complexity requirements
# =============================================================================

- name: CIS 1.1.5 | AUDIT | Get current password complexity setting
  ansible.windows.win_shell: |
    secedit /export /cfg C:\temp\secedit_export.cfg | Out-Null
    if (Test-Path C:\temp\secedit_export.cfg) {
      $content = Get-Content C:\temp\secedit_export.cfg
      $complexity = ($content | Select-String "PasswordComplexity").ToString().Split("=")[1].Trim()
      if ($complexity -eq "1") { "Enabled" } else { "Disabled" }
    } else { "Unknown" }
  register: windows_server__cis_1_1_5_current
  changed_when: false
  failed_when: false
  check_mode: false
  tags:
    - cis_1.1.5
    - password_policies
    - level_1
    - audit

- name: CIS 1.1.5 | SCORED | Set password complexity requirements
  ansible.windows.win_shell: |
    $tempFile = "C:\temp\password_complexity.cfg"
    "[System Access]" | Out-File $tempFile
    "PasswordComplexity = {{ '1' if windows_server__cis_password_complexity_enabled else '0' }}" | Add-Content $tempFile
    secedit /configure /db C:\temp\secedit.sdb /cfg $tempFile
  register: windows_server__cis_1_1_5_result
  when:
    - "'1.1.5' not in windows_server__cis_skip_rules"
    - (windows_server__cis_1_1_5_current.stdout | trim == "Enabled") != (windows_server__cis_password_complexity_enabled | bool)
  tags:
    - cis_1.1.5
    - password_policies
    - level_1
    - scored

- name: CIS 1.1.5 | AUDIT | Record compliance result
  ansible.builtin.set_fact:
    windows_server__cis_results: >-
      {{ windows_server__cis_results + [{
        'rule_id': '1.1.5',
        'rule_title': 'Password complexity requirements',
        'rule_section': 'Password Policy',
        'severity': 'High',
        'scored': true,
        'level': 'Level 1',
        'expected_value': 'Enabled' if windows_server__cis_password_complexity_enabled else 'Disabled',
        'current_value': windows_server__cis_1_1_5_current.stdout | trim,
        'status': 'PASS' if ((windows_server__cis_1_1_5_current.stdout | trim == "Enabled") == (windows_server__cis_password_complexity_enabled | bool)) else 'FAIL',
        'changed': windows_server__cis_1_1_5_result.changed | default(false),
        'skip_reason': 'User configured skip' if '1.1.5' in windows_server__cis_skip_rules else '',
        'check_mode': ansible_check_mode
      }] }}
    windows_server__cis_failed_controls: >-
      {{ windows_server__cis_failed_controls + ['1.1.5'] 
         if ((windows_server__cis_1_1_5_current.stdout | trim == "Enabled") != (windows_server__cis_password_complexity_enabled | bool) and 
             '1.1.5' not in windows_server__cis_skip_rules) 
         else windows_server__cis_failed_controls }}
    windows_server__cis_skipped_controls: >-
      {{ windows_server__cis_skipped_controls + ['1.1.5'] 
         if '1.1.5' in windows_server__cis_skip_rules 
         else windows_server__cis_skipped_controls }}
  tags:
    - cis_1.1.5
    - password_policies

# =============================================================================
# CIS 1.1.6 - Store passwords using reversible encryption
# =============================================================================

- name: CIS 1.1.6 | AUDIT | Get current reversible encryption setting
  ansible.windows.win_shell: |
    secedit /export /cfg C:\temp\secedit_export.cfg | Out-Null
    if (Test-Path C:\temp\secedit_export.cfg) {
      $content = Get-Content C:\temp\secedit_export.cfg
      $reversible = ($content | Select-String "ClearTextPassword").ToString().Split("=")[1].Trim()
      if ($reversible -eq "1") { "Enabled" } else { "Disabled" }
    } else { "Unknown" }
  register: windows_server__cis_1_1_6_current
  changed_when: false
  failed_when: false
  check_mode: false
  tags:
    - cis_1.1.6
    - password_policies
    - level_1
    - audit

- name: CIS 1.1.6 | SCORED | Set reversible encryption policy
  ansible.windows.win_shell: |
    $tempFile = "C:\temp\reversible_encryption.cfg"
    "[System Access]" | Out-File $tempFile
    "ClearTextPassword = {{ '1' if windows_server__cis_password_reversible_encryption else '0' }}" | Add-Content $tempFile
    secedit /configure /db C:\temp\secedit.sdb /cfg $tempFile
  register: windows_server__cis_1_1_6_result
  when:
    - "'1.1.6' not in windows_server__cis_skip_rules"
    - (windows_server__cis_1_1_6_current.stdout | trim == "Enabled") != (windows_server__cis_password_reversible_encryption | bool)
  tags:
    - cis_1.1.6
    - password_policies
    - level_1
    - scored

- name: CIS 1.1.6 | AUDIT | Record compliance result
  ansible.builtin.set_fact:
    windows_server__cis_results: >-
      {{ windows_server__cis_results + [{
        'rule_id': '1.1.6',
        'rule_title': 'Store passwords using reversible encryption',
        'rule_section': 'Password Policy',
        'severity': 'High',
        'scored': true,
        'level': 'Level 1',
        'expected_value': 'Disabled' if not windows_server__cis_password_reversible_encryption else 'Enabled',
        'current_value': windows_server__cis_1_1_6_current.stdout | trim,
        'status': 'PASS' if ((windows_server__cis_1_1_6_current.stdout | trim == "Enabled") == (windows_server__cis_password_reversible_encryption | bool)) else 'FAIL',
        'changed': windows_server__cis_1_1_6_result.changed | default(false),
        'skip_reason': 'User configured skip' if '1.1.6' in windows_server__cis_skip_rules else '',
        'check_mode': ansible_check_mode
      }] }}
    windows_server__cis_failed_controls: >-
      {{ windows_server__cis_failed_controls + ['1.1.6'] 
         if ((windows_server__cis_1_1_6_current.stdout | trim == "Enabled") != (windows_server__cis_password_reversible_encryption | bool) and 
             '1.1.6' not in windows_server__cis_skip_rules) 
         else windows_server__cis_failed_controls }}
    windows_server__cis_skipped_controls: >-
      {{ windows_server__cis_skipped_controls + ['1.1.6'] 
         if '1.1.6' in windows_server__cis_skip_rules 
         else windows_server__cis_skipped_controls }}
  tags:
    - cis_1.1.6
    - password_policies

# =============================================================================
# SECTION SUMMARY
# =============================================================================

- name: CIS Section 1.1 | Display password policy configuration summary
  ansible.builtin.debug:
    msg:
      - "=========================================="
      - "CIS Section 1.1: Password Policy Summary"
      - "=========================================="
      - "1.1.1 Password History: {{ windows_server__cis_password_history_size }} passwords ({{ 'COMPLIANT' if windows_server__cis_1_1_1_current.stdout | trim == windows_server__cis_password_history_size | string else 'NON-COMPLIANT' }})"
      - "1.1.2 Maximum Password Age: {{ windows_server__cis_maximum_password_age }} days ({{ 'COMPLIANT' if windows_server__cis_1_1_2_current.stdout | trim == windows_server__cis_maximum_password_age | string else 'NON-COMPLIANT' }})"
      - "1.1.3 Minimum Password Age: {{ windows_server__cis_minimum_password_age }} days ({{ 'COMPLIANT' if windows_server__cis_1_1_3_current.stdout | trim == windows_server__cis_minimum_password_age | string else 'NON-COMPLIANT' }})"
      - "1.1.4 Minimum Password Length: {{ windows_server__cis_minimum_password_length }} chars ({{ 'COMPLIANT' if windows_server__cis_1_1_4_current.stdout | trim == windows_server__cis_minimum_password_length | string else 'NON-COMPLIANT' }})"
      - "1.1.5 Password Complexity: {{ 'Enabled' if windows_server__cis_password_complexity_enabled else 'Disabled' }} ({{ 'COMPLIANT' if ((windows_server__cis_1_1_5_current.stdout | trim == 'Enabled') == (windows_server__cis_password_complexity_enabled | bool)) else 'NON-COMPLIANT' }})"
      - "1.1.6 Reversible Encryption: {{ 'Disabled' if not windows_server__cis_password_reversible_encryption else 'Enabled' }} ({{ 'COMPLIANT' if ((windows_server__cis_1_1_6_current.stdout | trim == 'Enabled') == (windows_server__cis_password_reversible_encryption | bool)) else 'NON-COMPLIANT' }})"
      - "=========================================="
      - "Execution Mode: {{ 'CHECK MODE (No Changes Applied)' if ansible_check_mode else 'APPLY MODE (Changes Applied)' }}"
      - "=========================================="
  when: not ansible_check_mode or true  # Always show in both modes
  tags:
    - password_policies
    - section_1
    - summary