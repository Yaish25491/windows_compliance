---
# CIS Microsoft Windows Server 2022 Benchmark v1.0.0
# Section 9: Windows Firewall with Advanced Security
# Enterprise Implementation - Critical Firewall Controls (15 controls)

# =============================================================================
# CIS 9.1 - Domain Profile
# =============================================================================

# CIS 9.1.1 - Windows Firewall: Domain: Firewall state
- name: CIS 9.1.1 | AUDIT | Get current Domain firewall state
  ansible.windows.win_shell: |
    netsh advfirewall show domainprofile state
  register: windows_server__cis_9_1_1_current_raw
  changed_when: false
  tags:
    - cis_9.1.1
    - windows_firewall
    - level_1
    - audit

- name: CIS 9.1.1 | FACT | Parse Domain firewall state
  ansible.builtin.set_fact:
    windows_server__cis_9_1_1_current: "{{ 'On' if 'State  On' in windows_server__cis_9_1_1_current_raw.stdout else 'Off' }}"
  tags:
    - cis_9.1.1
    - windows_firewall

- name: CIS 9.1.1 | SCORED | Configure Domain firewall state (should be On)
  ansible.windows.win_shell: |
    netsh advfirewall set domainprofile state {{ windows_server_cis_windows_firewall_domain_firewall_state | lower }}
  register: windows_server__cis_9_1_1_result
  when:
    - "'9.1.1' not in windows_server__cis_skip_rules"
    - windows_server__cis_9_1_1_current != windows_server_cis_windows_firewall_domain_firewall_state
  tags:
    - cis_9.1.1
    - windows_firewall
    - level_1
    - scored

- name: CIS 9.1.1 | AUDIT | Record compliance result
  ansible.builtin.set_fact:
    windows_server__cis_results: >-
      {{ windows_server__cis_results + [{
        'rule_id': '9.1.1',
        'rule_title': 'Windows Firewall: Domain: Firewall state',
        'rule_section': 'Windows Firewall - Domain Profile',
        'severity': 'High',
        'scored': true,
        'level': 'Level 1',
        'expected_value': windows_server_cis_windows_firewall_domain_firewall_state,
        'current_value': windows_server__cis_9_1_1_current,
        'status': 'PASS' if (windows_server__cis_9_1_1_current == windows_server_cis_windows_firewall_domain_firewall_state) else 'FAIL',
        'changed': windows_server__cis_9_1_1_result.changed | default(false),
        'skip_reason': 'User configured skip' if '9.1.1' in windows_server__cis_skip_rules else '',
        'check_mode': ansible_check_mode
      }] }}
  tags:
    - cis_9.1.1
    - windows_firewall

# CIS 9.1.2 - Windows Firewall: Domain: Inbound connections
- name: CIS 9.1.2 | AUDIT | Get current Domain inbound connections setting
  ansible.windows.win_shell: |
    netsh advfirewall show domainprofile firewallpolicy
  register: windows_server__cis_9_1_2_current_raw
  changed_when: false
  tags:
    - cis_9.1.2
    - windows_firewall
    - level_1
    - audit

- name: CIS 9.1.2 | FACT | Parse Domain inbound connections setting
  ansible.builtin.set_fact:
    windows_server__cis_9_1_2_current: "{{ 'Block' if 'Inbound  Block' in windows_server__cis_9_1_2_current_raw.stdout else 'Allow' }}"
  tags:
    - cis_9.1.2
    - windows_firewall

- name: CIS 9.1.2 | SCORED | Configure Domain inbound connections (should be Block)
  ansible.windows.win_shell: |
    netsh advfirewall set domainprofile firewallpolicy blockinbound,allowoutbound
  register: windows_server__cis_9_1_2_result
  when:
    - "'9.1.2' not in windows_server__cis_skip_rules"
    - windows_server__cis_9_1_2_current != windows_server_cis_windows_firewall_domain_inbound_connections
  tags:
    - cis_9.1.2
    - windows_firewall
    - level_1
    - scored

- name: CIS 9.1.2 | AUDIT | Record compliance result
  ansible.builtin.set_fact:
    windows_server__cis_results: >-
      {{ windows_server__cis_results + [{
        'rule_id': '9.1.2',
        'rule_title': 'Windows Firewall: Domain: Inbound connections',
        'rule_section': 'Windows Firewall - Domain Profile',
        'severity': 'High',
        'scored': true,
        'level': 'Level 1',
        'expected_value': windows_server_cis_windows_firewall_domain_inbound_connections,
        'current_value': windows_server__cis_9_1_2_current,
        'status': 'PASS' if (windows_server__cis_9_1_2_current == windows_server_cis_windows_firewall_domain_inbound_connections) else 'FAIL',
        'changed': windows_server__cis_9_1_2_result.changed | default(false),
        'skip_reason': 'User configured skip' if '9.1.2' in windows_server__cis_skip_rules else '',
        'check_mode': ansible_check_mode
      }] }}
  tags:
    - cis_9.1.2
    - windows_firewall

# CIS 9.1.3 - Windows Firewall: Domain: Outbound connections  
- name: CIS 9.1.3 | AUDIT | Get current Domain outbound connections setting
  ansible.windows.win_shell: |
    netsh advfirewall show domainprofile firewallpolicy
  register: windows_server__cis_9_1_3_current_raw
  changed_when: false
  tags:
    - cis_9.1.3
    - windows_firewall
    - level_1
    - audit

- name: CIS 9.1.3 | FACT | Parse Domain outbound connections setting
  ansible.builtin.set_fact:
    windows_server__cis_9_1_3_current: "{{ 'Allow' if 'Outbound  Allow' in windows_server__cis_9_1_3_current_raw.stdout else 'Block' }}"
  tags:
    - cis_9.1.3
    - windows_firewall

- name: CIS 9.1.3 | SCORED | Configure Domain outbound connections (should be Allow)
  ansible.windows.win_shell: |
    netsh advfirewall set domainprofile firewallpolicy blockinbound,allowoutbound
  register: windows_server__cis_9_1_3_result
  when:
    - "'9.1.3' not in windows_server__cis_skip_rules"
    - windows_server__cis_9_1_3_current != windows_server_cis_windows_firewall_domain_outbound_connections
  tags:
    - cis_9.1.3
    - windows_firewall
    - level_1
    - scored

- name: CIS 9.1.3 | AUDIT | Record compliance result
  ansible.builtin.set_fact:
    windows_server__cis_results: >-
      {{ windows_server__cis_results + [{
        'rule_id': '9.1.3',
        'rule_title': 'Windows Firewall: Domain: Outbound connections',
        'rule_section': 'Windows Firewall - Domain Profile',
        'severity': 'Medium',
        'scored': true,
        'level': 'Level 1',
        'expected_value': windows_server_cis_windows_firewall_domain_outbound_connections,
        'current_value': windows_server__cis_9_1_3_current,
        'status': 'PASS' if (windows_server__cis_9_1_3_current == windows_server_cis_windows_firewall_domain_outbound_connections) else 'FAIL',
        'changed': windows_server__cis_9_1_3_result.changed | default(false),
        'skip_reason': 'User configured skip' if '9.1.3' in windows_server__cis_skip_rules else '',
        'check_mode': ansible_check_mode
      }] }}
  tags:
    - cis_9.1.3
    - windows_firewall

# CIS 9.1.4 - Windows Firewall: Domain: Settings: Display a notification
- name: CIS 9.1.4 | AUDIT | Get current Domain notification setting
  ansible.windows.win_reg_stat:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\DomainProfile
    name: DisableNotifications
  register: windows_server__cis_9_1_4_current
  tags:
    - cis_9.1.4
    - windows_firewall
    - level_1
    - audit

- name: CIS 9.1.4 | SCORED | Configure Domain notification setting (should be disabled)
  ansible.windows.win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\DomainProfile
    name: DisableNotifications
    data: "{{ 0 if windows_server_cis_windows_firewall_domain_settings_display_notification else 1 }}"
    type: dword
  register: windows_server__cis_9_1_4_result
  when:
    - "'9.1.4' not in windows_server__cis_skip_rules"
    - windows_server__cis_9_1_4_current.value | default(1) != (0 if windows_server_cis_windows_firewall_domain_settings_display_notification else 1)
  tags:
    - cis_9.1.4
    - windows_firewall
    - level_1
    - scored

- name: CIS 9.1.4 | AUDIT | Record compliance result
  ansible.builtin.set_fact:
    windows_server__cis_results: >-
      {{ windows_server__cis_results + [{
        'rule_id': '9.1.4',
        'rule_title': 'Windows Firewall: Domain: Settings: Display a notification',
        'rule_section': 'Windows Firewall - Domain Profile',
        'severity': 'Low',
        'scored': true,
        'level': 'Level 1',
        'expected_value': 'No' if not windows_server_cis_windows_firewall_domain_settings_display_notification else 'Yes',
        'current_value': 'No' if (windows_server__cis_9_1_4_current.value | default(1) == 1) else 'Yes',
        'status': 'PASS' if (windows_server__cis_9_1_4_current.value | default(1) == (0 if windows_server_cis_windows_firewall_domain_settings_display_notification else 1)) else 'FAIL',
        'changed': windows_server__cis_9_1_4_result.changed | default(false),
        'skip_reason': 'User configured skip' if '9.1.4' in windows_server__cis_skip_rules else '',
        'check_mode': ansible_check_mode
      }] }}
  tags:
    - cis_9.1.4
    - windows_firewall

# CIS 9.1.5 - Windows Firewall: Domain: Logging: Name
- name: CIS 9.1.5 | AUDIT | Get current Domain logging name setting
  ansible.windows.win_reg_stat:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\DomainProfile\Logging
    name: LogFilePath
  register: windows_server__cis_9_1_5_current
  tags:
    - cis_9.1.5
    - windows_firewall
    - level_1
    - audit

- name: CIS 9.1.5 | SCORED | Configure Domain logging name
  ansible.windows.win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\DomainProfile\Logging
    name: LogFilePath
    data: "{{ windows_server_cis_windows_firewall_domain_logging_name }}"
    type: string
  register: windows_server__cis_9_1_5_result
  when:
    - "'9.1.5' not in windows_server__cis_skip_rules"
    - windows_server__cis_9_1_5_current.value | default('') != windows_server_cis_windows_firewall_domain_logging_name
  tags:
    - cis_9.1.5
    - windows_firewall
    - level_1
    - scored

- name: CIS 9.1.5 | AUDIT | Record compliance result
  ansible.builtin.set_fact:
    windows_server__cis_results: >-
      {{ windows_server__cis_results + [{
        'rule_id': '9.1.5',
        'rule_title': 'Windows Firewall: Domain: Logging: Name',
        'rule_section': 'Windows Firewall - Domain Profile',
        'severity': 'Medium',
        'scored': true,
        'level': 'Level 1',
        'expected_value': windows_server_cis_windows_firewall_domain_logging_name,
        'current_value': windows_server__cis_9_1_5_current.value | default('Not Configured'),
        'status': 'PASS' if (windows_server__cis_9_1_5_current.value | default('') == windows_server_cis_windows_firewall_domain_logging_name) else 'FAIL',
        'changed': windows_server__cis_9_1_5_result.changed | default(false),
        'skip_reason': 'User configured skip' if '9.1.5' in windows_server__cis_skip_rules else '',
        'check_mode': ansible_check_mode
      }] }}
  tags:
    - cis_9.1.5
    - windows_firewall

# =============================================================================
# CIS 9.2 - Private Profile
# =============================================================================

# CIS 9.2.1 - Windows Firewall: Private: Firewall state
- name: CIS 9.2.1 | AUDIT | Get current Private firewall state
  ansible.windows.win_shell: |
    netsh advfirewall show privateprofile state
  register: windows_server__cis_9_2_1_current_raw
  changed_when: false
  tags:
    - cis_9.2.1
    - windows_firewall
    - level_1
    - audit

- name: CIS 9.2.1 | FACT | Parse Private firewall state
  ansible.builtin.set_fact:
    windows_server__cis_9_2_1_current: "{{ 'On' if 'State  On' in windows_server__cis_9_2_1_current_raw.stdout else 'Off' }}"
  tags:
    - cis_9.2.1
    - windows_firewall

- name: CIS 9.2.1 | SCORED | Configure Private firewall state (should be On)
  ansible.windows.win_shell: |
    netsh advfirewall set privateprofile state {{ windows_server_cis_windows_firewall_private_firewall_state | lower }}
  register: windows_server__cis_9_2_1_result
  when:
    - "'9.2.1' not in windows_server__cis_skip_rules"
    - windows_server__cis_9_2_1_current != windows_server_cis_windows_firewall_private_firewall_state
  tags:
    - cis_9.2.1
    - windows_firewall
    - level_1
    - scored

- name: CIS 9.2.1 | AUDIT | Record compliance result
  ansible.builtin.set_fact:
    windows_server__cis_results: >-
      {{ windows_server__cis_results + [{
        'rule_id': '9.2.1',
        'rule_title': 'Windows Firewall: Private: Firewall state',
        'rule_section': 'Windows Firewall - Private Profile',
        'severity': 'High',
        'scored': true,
        'level': 'Level 1',
        'expected_value': windows_server_cis_windows_firewall_private_firewall_state,
        'current_value': windows_server__cis_9_2_1_current,
        'status': 'PASS' if (windows_server__cis_9_2_1_current == windows_server_cis_windows_firewall_private_firewall_state) else 'FAIL',
        'changed': windows_server__cis_9_2_1_result.changed | default(false),
        'skip_reason': 'User configured skip' if '9.2.1' in windows_server__cis_skip_rules else '',
        'check_mode': ansible_check_mode
      }] }}
  tags:
    - cis_9.2.1
    - windows_firewall

# CIS 9.2.2 - Windows Firewall: Private: Inbound connections
- name: CIS 9.2.2 | AUDIT | Get current Private inbound connections setting
  ansible.windows.win_shell: |
    netsh advfirewall show privateprofile firewallpolicy
  register: windows_server__cis_9_2_2_current_raw
  changed_when: false
  tags:
    - cis_9.2.2
    - windows_firewall
    - level_1
    - audit

- name: CIS 9.2.2 | FACT | Parse Private inbound connections setting
  ansible.builtin.set_fact:
    windows_server__cis_9_2_2_current: "{{ 'Block' if 'Inbound  Block' in windows_server__cis_9_2_2_current_raw.stdout else 'Allow' }}"
  tags:
    - cis_9.2.2
    - windows_firewall

- name: CIS 9.2.2 | SCORED | Configure Private inbound connections (should be Block)
  ansible.windows.win_shell: |
    netsh advfirewall set privateprofile firewallpolicy blockinbound,allowoutbound
  register: windows_server__cis_9_2_2_result
  when:
    - "'9.2.2' not in windows_server__cis_skip_rules"
    - windows_server__cis_9_2_2_current != windows_server_cis_windows_firewall_private_inbound_connections
  tags:
    - cis_9.2.2
    - windows_firewall
    - level_1
    - scored

- name: CIS 9.2.2 | AUDIT | Record compliance result
  ansible.builtin.set_fact:
    windows_server__cis_results: >-
      {{ windows_server__cis_results + [{
        'rule_id': '9.2.2',
        'rule_title': 'Windows Firewall: Private: Inbound connections',
        'rule_section': 'Windows Firewall - Private Profile',
        'severity': 'High',
        'scored': true,
        'level': 'Level 1',
        'expected_value': windows_server_cis_windows_firewall_private_inbound_connections,
        'current_value': windows_server__cis_9_2_2_current,
        'status': 'PASS' if (windows_server__cis_9_2_2_current == windows_server_cis_windows_firewall_private_inbound_connections) else 'FAIL',
        'changed': windows_server__cis_9_2_2_result.changed | default(false),
        'skip_reason': 'User configured skip' if '9.2.2' in windows_server__cis_skip_rules else '',
        'check_mode': ansible_check_mode
      }] }}
  tags:
    - cis_9.2.2
    - windows_firewall

# =============================================================================
# CIS 9.3 - Public Profile
# =============================================================================

# CIS 9.3.1 - Windows Firewall: Public: Firewall state
- name: CIS 9.3.1 | AUDIT | Get current Public firewall state
  ansible.windows.win_shell: |
    netsh advfirewall show publicprofile state
  register: windows_server__cis_9_3_1_current_raw
  changed_when: false
  tags:
    - cis_9.3.1
    - windows_firewall
    - level_1
    - audit

- name: CIS 9.3.1 | FACT | Parse Public firewall state
  ansible.builtin.set_fact:
    windows_server__cis_9_3_1_current: "{{ 'On' if 'State  On' in windows_server__cis_9_3_1_current_raw.stdout else 'Off' }}"
  tags:
    - cis_9.3.1
    - windows_firewall

- name: CIS 9.3.1 | SCORED | Configure Public firewall state (should be On)
  ansible.windows.win_shell: |
    netsh advfirewall set publicprofile state {{ windows_server_cis_windows_firewall_public_firewall_state | lower }}
  register: windows_server__cis_9_3_1_result
  when:
    - "'9.3.1' not in windows_server__cis_skip_rules"
    - windows_server__cis_9_3_1_current != windows_server_cis_windows_firewall_public_firewall_state
  tags:
    - cis_9.3.1
    - windows_firewall
    - level_1
    - scored

- name: CIS 9.3.1 | AUDIT | Record compliance result
  ansible.builtin.set_fact:
    windows_server__cis_results: >-
      {{ windows_server__cis_results + [{
        'rule_id': '9.3.1',
        'rule_title': 'Windows Firewall: Public: Firewall state',
        'rule_section': 'Windows Firewall - Public Profile',
        'severity': 'High',
        'scored': true,
        'level': 'Level 1',
        'expected_value': windows_server_cis_windows_firewall_public_firewall_state,
        'current_value': windows_server__cis_9_3_1_current,
        'status': 'PASS' if (windows_server__cis_9_3_1_current == windows_server_cis_windows_firewall_public_firewall_state) else 'FAIL',
        'changed': windows_server__cis_9_3_1_result.changed | default(false),
        'skip_reason': 'User configured skip' if '9.3.1' in windows_server__cis_skip_rules else '',
        'check_mode': ansible_check_mode
      }] }}
  tags:
    - cis_9.3.1
    - windows_firewall

# CIS 9.3.2 - Windows Firewall: Public: Inbound connections
- name: CIS 9.3.2 | AUDIT | Get current Public inbound connections setting
  ansible.windows.win_shell: |
    netsh advfirewall show publicprofile firewallpolicy
  register: windows_server__cis_9_3_2_current_raw
  changed_when: false
  tags:
    - cis_9.3.2
    - windows_firewall
    - level_1
    - audit

- name: CIS 9.3.2 | FACT | Parse Public inbound connections setting
  ansible.builtin.set_fact:
    windows_server__cis_9_3_2_current: "{{ 'Block' if 'Inbound  Block' in windows_server__cis_9_3_2_current_raw.stdout else 'Allow' }}"
  tags:
    - cis_9.3.2
    - windows_firewall

- name: CIS 9.3.2 | SCORED | Configure Public inbound connections (should be Block)
  ansible.windows.win_shell: |
    netsh advfirewall set publicprofile firewallpolicy blockinbound,allowoutbound
  register: windows_server__cis_9_3_2_result
  when:
    - "'9.3.2' not in windows_server__cis_skip_rules"
    - windows_server__cis_9_3_2_current != windows_server_cis_windows_firewall_public_inbound_connections
  tags:
    - cis_9.3.2
    - windows_firewall
    - level_1
    - scored

- name: CIS 9.3.2 | AUDIT | Record compliance result
  ansible.builtin.set_fact:
    windows_server__cis_results: >-
      {{ windows_server__cis_results + [{
        'rule_id': '9.3.2',
        'rule_title': 'Windows Firewall: Public: Inbound connections',
        'rule_section': 'Windows Firewall - Public Profile',
        'severity': 'High',
        'scored': true,
        'level': 'Level 1',
        'expected_value': windows_server_cis_windows_firewall_public_inbound_connections,
        'current_value': windows_server__cis_9_3_2_current,
        'status': 'PASS' if (windows_server__cis_9_3_2_current == windows_server_cis_windows_firewall_public_inbound_connections) else 'FAIL',
        'changed': windows_server__cis_9_3_2_result.changed | default(false),
        'skip_reason': 'User configured skip' if '9.3.2' in windows_server__cis_skip_rules else '',
        'check_mode': ansible_check_mode
      }] }}
  tags:
    - cis_9.3.2
    - windows_firewall

# =============================================================================
# SECTION SUMMARY - Windows Firewall with Advanced Security
# =============================================================================

- name: CIS Section 9 | Display Windows Firewall summary
  ansible.builtin.debug:
    msg:
      - "=========================================="
      - "CIS Section 9: Windows Firewall Summary"  
      - "=========================================="
      - "ENTERPRISE IMPLEMENTATION - 10 critical firewall controls"
      - ""
      - "Domain Profile:"
      - "9.1.1 Firewall State: {{ 'COMPLIANT' if windows_server__cis_9_1_1_current == 'On' else 'NON-COMPLIANT' }}"
      - "9.1.2 Inbound Connections: {{ 'COMPLIANT' if windows_server__cis_9_1_2_current == 'Block' else 'NON-COMPLIANT' }}"
      - "9.1.3 Outbound Connections: {{ 'COMPLIANT' if windows_server__cis_9_1_3_current == 'Allow' else 'NON-COMPLIANT' }}"
      - "9.1.4 Display Notification: {{ 'COMPLIANT' if (windows_server__cis_9_1_4_current.value | default(1) == 1) else 'NON-COMPLIANT' }}"
      - "9.1.5 Logging Name: {{ 'COMPLIANT' if (windows_server__cis_9_1_5_current.value | default('') == windows_server_cis_windows_firewall_domain_logging_name) else 'NON-COMPLIANT' }}"
      - ""
      - "Private Profile:"
      - "9.2.1 Firewall State: {{ 'COMPLIANT' if windows_server__cis_9_2_1_current == 'On' else 'NON-COMPLIANT' }}"
      - "9.2.2 Inbound Connections: {{ 'COMPLIANT' if windows_server__cis_9_2_2_current == 'Block' else 'NON-COMPLIANT' }}"
      - ""
      - "Public Profile:"
      - "9.3.1 Firewall State: {{ 'COMPLIANT' if windows_server__cis_9_3_1_current == 'On' else 'NON-COMPLIANT' }}"
      - "9.3.2 Inbound Connections: {{ 'COMPLIANT' if windows_server__cis_9_3_2_current == 'Block' else 'NON-COMPLIANT' }}"
      - ""
      - "Note: Additional 5 firewall controls require implementation for complete coverage"
      - "This demonstrates enterprise Windows Firewall automation"
      - "=========================================="
      - "Execution Mode: {{ 'CHECK MODE (No Changes Applied)' if ansible_check_mode else 'APPLY MODE (Changes Applied)' }}"
      - "=========================================="
  when: not ansible_check_mode or true
  tags:
    - windows_firewall
    - section_9
    - summary