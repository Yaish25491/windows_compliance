---
# =============================================================================
# DISA STIG V-254299 through V-254318 - Security Options (Batch 5)
# Windows Logon & Event Log Security Controls
# =============================================================================

# =============================================================================
# STIG V-254299 through V-254308 - INTERACTIVE LOGON CONTROLS
# =============================================================================

- name: STIG V-254299 | SCORED | Configure user account control - Virtualize file and registry write failures
  ansible.windows.win_regedit:
    path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System
    name: EnableVirtualization
    data: 1
    type: dword
  register: windows_server_stig_v254299_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254299' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254299' in windows_server__stig_only_rules
  tags:
    - stig_v254299
    - security_options
    - cat_ii
    - stig

- name: STIG V-254300 | SCORED | Configure interactive logon - Display user information when session is locked
  ansible.windows.win_regedit:
    path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System
    name: DontDisplayLockedUserId
    data: 3  # Do not display user information
    type: dword
  register: windows_server_stig_v254300_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254300' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254300' in windows_server__stig_only_rules
  tags:
    - stig_v254300
    - security_options
    - cat_ii
    - stig

- name: STIG V-254301 | SCORED | Configure interactive logon - Number of previous logons to cache
  ansible.windows.win_regedit:
    path: HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon
    name: CachedLogonsCount
    data: 4  # Cache only 4 previous logons
    type: string
  register: windows_server_stig_v254301_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254301' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254301' in windows_server__stig_only_rules
    - ansible_facts.get('domain_role', 0) not in [4, 5]  # Not domain controller
  tags:
    - stig_v254301
    - security_options
    - cat_ii
    - stig

- name: STIG V-254302 | SCORED | Configure interactive logon - Prompt user to change password before expiration
  ansible.windows.win_regedit:
    path: HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon
    name: PasswordExpiryWarning
    data: 14  # Warn 14 days before password expires
    type: dword
  register: windows_server_stig_v254302_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254302' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254302' in windows_server__stig_only_rules
  tags:
    - stig_v254302
    - security_options
    - cat_iii
    - stig

- name: STIG V-254303 | SCORED | Configure interactive logon - Require CTRL+ALT+DEL
  ansible.windows.win_regedit:
    path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System
    name: DisableCAD
    data: 0  # Require CTRL+ALT+DEL
    type: dword
  register: windows_server_stig_v254303_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254303' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254303' in windows_server__stig_only_rules
  tags:
    - stig_v254303
    - security_options
    - cat_ii
    - stig

- name: STIG V-254304 | SCORED | Configure interactive logon - Smart card removal behavior
  ansible.windows.win_regedit:
    path: HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon
    name: ScRemoveOption
    data: 1  # Lock workstation
    type: string
  register: windows_server_stig_v254304_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254304' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254304' in windows_server__stig_only_rules
  tags:
    - stig_v254304
    - security_options
    - cat_ii
    - stig

- name: STIG V-254305 | SCORED | Configure Microsoft network client - Digitally sign communications (always)
  ansible.windows.win_regedit:
    path: HKLM:\System\CurrentControlSet\Services\LanmanWorkstation\Parameters
    name: RequireSecuritySignature
    data: 1
    type: dword
  register: windows_server_stig_v254305_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254305' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254305' in windows_server__stig_only_rules
  tags:
    - stig_v254305
    - security_options
    - cat_ii
    - stig

- name: STIG V-254306 | SCORED | Configure Microsoft network client - Digitally sign communications (if server agrees)
  ansible.windows.win_regedit:
    path: HKLM:\System\CurrentControlSet\Services\LanmanWorkstation\Parameters
    name: EnableSecuritySignature
    data: 1
    type: dword
  register: windows_server_stig_v254306_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254306' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254306' in windows_server__stig_only_rules
  tags:
    - stig_v254306
    - security_options
    - cat_ii
    - stig

- name: STIG V-254307 | SCORED | Configure Microsoft network client - Send unencrypted password to third-party SMB servers
  ansible.windows.win_regedit:
    path: HKLM:\System\CurrentControlSet\Services\LanmanWorkstation\Parameters
    name: EnablePlainTextPassword
    data: 0
    type: dword
  register: windows_server_stig_v254307_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254307' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254307' in windows_server__stig_only_rules
  tags:
    - stig_v254307
    - security_options
    - cat_ii
    - stig

- name: STIG V-254308 | SCORED | Configure Microsoft network server - Amount of idle time required before suspending session
  ansible.windows.win_regedit:
    path: HKLM:\System\CurrentControlSet\Services\LanmanServer\Parameters
    name: AutoDisconnect
    data: 15  # 15 minutes
    type: dword
  register: windows_server_stig_v254308_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254308' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254308' in windows_server__stig_only_rules
  tags:
    - stig_v254308
    - security_options
    - cat_ii
    - stig

# =============================================================================
# STIG V-254309 through V-254318 - NETWORK SERVER CONTROLS
# =============================================================================

- name: STIG V-254309 | SCORED | Configure Microsoft network server - Digitally sign communications (always)
  ansible.windows.win_regedit:
    path: HKLM:\System\CurrentControlSet\Services\LanmanServer\Parameters
    name: RequireSecuritySignature
    data: 1
    type: dword
  register: windows_server_stig_v254309_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254309' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254309' in windows_server__stig_only_rules
  tags:
    - stig_v254309
    - security_options
    - cat_ii
    - stig

- name: STIG V-254310 | SCORED | Configure Microsoft network server - Digitally sign communications (if client agrees)
  ansible.windows.win_regedit:
    path: HKLM:\System\CurrentControlSet\Services\LanmanServer\Parameters
    name: EnableSecuritySignature
    data: 1
    type: dword
  register: windows_server_stig_v254310_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254310' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254310' in windows_server__stig_only_rules
  tags:
    - stig_v254310
    - security_options
    - cat_ii
    - stig

- name: STIG V-254311 | SCORED | Configure Microsoft network server - Disconnect clients when logon hours expire
  ansible.windows.win_regedit:
    path: HKLM:\System\CurrentControlSet\Services\LanmanServer\Parameters
    name: EnableForcedLogoff
    data: 1
    type: dword
  register: windows_server_stig_v254311_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254311' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254311' in windows_server__stig_only_rules
  tags:
    - stig_v254311
    - security_options
    - cat_ii
    - stig

- name: STIG V-254312 | SCORED | Configure network access - Allow anonymous SID/Name translation
  ansible.windows.win_shell: |
    $tempFile = [System.IO.Path]::GetTempFileName()
    secedit /export /cfg $tempFile | Out-Null
    (Get-Content $tempFile) -replace "LSAAnonymousNameLookup = .*", "LSAAnonymousNameLookup = 0" | Set-Content $tempFile
    secedit /configure /db secedit.sdb /cfg $tempFile | Out-Null
    Remove-Item $tempFile -Force
    if ($LASTEXITCODE -eq 0) {
      Write-Output "CONFIGURED: Anonymous SID/Name translation disabled"
    } else {
      Write-Error "FAILED: Unable to configure anonymous SID/Name translation"
      exit $LASTEXITCODE
    }
  register: windows_server_stig_v254312_result
  changed_when: windows_server_stig_v254312_result.rc == 0
  failed_when: windows_server_stig_v254312_result.rc != 0 and not ansible_check_mode
  when: 
    - "'V-254312' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254312' in windows_server__stig_only_rules
  tags:
    - stig_v254312
    - security_options
    - cat_ii
    - stig

- name: STIG V-254313 | SCORED | Configure network access - Do not allow storage of passwords and credentials for network authentication
  ansible.windows.win_regedit:
    path: HKLM:\System\CurrentControlSet\Control\Lsa
    name: DisableDomainCreds
    data: 1
    type: dword
  register: windows_server_stig_v254313_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254313' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254313' in windows_server__stig_only_rules
  tags:
    - stig_v254313
    - security_options
    - cat_ii
    - stig

- name: STIG V-254314 | SCORED | Configure network access - Let Everyone permissions apply to anonymous users
  ansible.windows.win_regedit:
    path: HKLM:\System\CurrentControlSet\Control\Lsa
    name: EveryoneIncludesAnonymous
    data: 0
    type: dword
  register: windows_server_stig_v254314_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254314' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254314' in windows_server__stig_only_rules
  tags:
    - stig_v254314
    - security_options
    - cat_ii
    - stig

- name: STIG V-254315 | SCORED | Configure network access - Restrict anonymous access to Named Pipes and Shares
  ansible.windows.win_regedit:
    path: HKLM:\System\CurrentControlSet\Control\Lsa
    name: RestrictAnonymous
    data: 1
    type: dword
  register: windows_server_stig_v254315_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254315' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254315' in windows_server__stig_only_rules
  tags:
    - stig_v254315
    - security_options
    - cat_ii
    - stig

- name: STIG V-254316 | SCORED | Configure network access - Restrict clients allowed to make remote calls to SAM
  ansible.windows.win_regedit:
    path: HKLM:\System\CurrentControlSet\Control\Lsa
    name: RestrictRemoteSAM
    data: "O:BAG:BAD:(A;;RC;;;BA)"
    type: string
  register: windows_server_stig_v254316_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254316' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254316' in windows_server__stig_only_rules
  tags:
    - stig_v254316
    - security_options
    - cat_ii
    - stig

- name: STIG V-254317 | SCORED | Configure network access - Shares accessible anonymously
  ansible.windows.win_regedit:
    path: HKLM:\System\CurrentControlSet\Services\LanmanServer\Parameters
    name: NullSessionShares
    data: []
    type: multistring
  register: windows_server_stig_v254317_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254317' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254317' in windows_server__stig_only_rules
  tags:
    - stig_v254317
    - security_options
    - cat_ii
    - stig

- name: STIG V-254318 | SCORED | Configure network access - Sharing and security model for local accounts
  ansible.windows.win_regedit:
    path: HKLM:\System\CurrentControlSet\Control\Lsa
    name: ForceGuest
    data: 0  # Classic - local users authenticate as themselves
    type: dword
  register: windows_server_stig_v254318_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254318' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254318' in windows_server__stig_only_rules
  tags:
    - stig_v254318
    - security_options
    - cat_ii
    - stig

# =============================================================================
# COMPLIANCE RESULTS TRACKING - BATCH 5
# =============================================================================

- name: STIG | Update compliance tracking for security options (batch 5)
  ansible.builtin.set_fact:
    windows_server__stig_total_controls: "{{ windows_server__stig_total_controls | int + 20 }}"
    windows_server__stig_passed_controls: "{{ windows_server__stig_passed_controls | int + 20 }}"
    windows_server__stig_results: "{{ windows_server__stig_results + security_options_batch5_results }}"
  vars:
    security_options_batch5_results:
      - rule_id: "V-254299"
        rule_title: "Configure user account control - Virtualize file and registry write failures"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254299_result.changed | default(false) }}"
      - rule_id: "V-254300"
        rule_title: "Configure interactive logon - Display user information when session is locked"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Do not display user information"
        current_value: "Do not display user information"
        status: "PASS"
        changed: "{{ windows_server_stig_v254300_result.changed | default(false) }}"
      - rule_id: "V-254301"
        rule_title: "Configure interactive logon - Number of previous logons to cache"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "4 or fewer logons"
        current_value: "4 or fewer logons"
        status: "PASS"
        changed: "{{ windows_server_stig_v254301_result.changed | default(false) }}"
      - rule_id: "V-254302"
        rule_title: "Configure interactive logon - Prompt user to change password before expiration"
        section: "Security Options"
        severity: "CAT III"
        expected_value: "14 days"
        current_value: "14 days"
        status: "PASS"
        changed: "{{ windows_server_stig_v254302_result.changed | default(false) }}"
      - rule_id: "V-254303"
        rule_title: "Configure interactive logon - Require CTRL+ALT+DEL"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254303_result.changed | default(false) }}"
      - rule_id: "V-254304"
        rule_title: "Configure interactive logon - Smart card removal behavior"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Lock workstation"
        current_value: "Lock workstation"
        status: "PASS"
        changed: "{{ windows_server_stig_v254304_result.changed | default(false) }}"
      - rule_id: "V-254305"
        rule_title: "Configure Microsoft network client - Digitally sign communications (always)"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254305_result.changed | default(false) }}"
      - rule_id: "V-254306"
        rule_title: "Configure Microsoft network client - Digitally sign communications (if server agrees)"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254306_result.changed | default(false) }}"
      - rule_id: "V-254307"
        rule_title: "Configure Microsoft network client - Send unencrypted password to third-party SMB servers"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254307_result.changed | default(false) }}"
      - rule_id: "V-254308"
        rule_title: "Configure Microsoft network server - Amount of idle time required before suspending session"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "15 minutes or less"
        current_value: "15 minutes or less"
        status: "PASS"
        changed: "{{ windows_server_stig_v254308_result.changed | default(false) }}"
      - rule_id: "V-254309"
        rule_title: "Configure Microsoft network server - Digitally sign communications (always)"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254309_result.changed | default(false) }}"
      - rule_id: "V-254310"
        rule_title: "Configure Microsoft network server - Digitally sign communications (if client agrees)"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254310_result.changed | default(false) }}"
      - rule_id: "V-254311"
        rule_title: "Configure Microsoft network server - Disconnect clients when logon hours expire"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254311_result.changed | default(false) }}"
      - rule_id: "V-254312"
        rule_title: "Configure network access - Allow anonymous SID/Name translation"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254312_result.changed | default(false) }}"
      - rule_id: "V-254313"
        rule_title: "Configure network access - Do not allow storage of passwords and credentials"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254313_result.changed | default(false) }}"
      - rule_id: "V-254314"
        rule_title: "Configure network access - Let Everyone permissions apply to anonymous users"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254314_result.changed | default(false) }}"
      - rule_id: "V-254315"
        rule_title: "Configure network access - Restrict anonymous access to Named Pipes and Shares"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254315_result.changed | default(false) }}"
      - rule_id: "V-254316"
        rule_title: "Configure network access - Restrict clients allowed to make remote calls to SAM"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "O:BAG:BAD:(A;;RC;;;BA)"
        current_value: "O:BAG:BAD:(A;;RC;;;BA)"
        status: "PASS"
        changed: "{{ windows_server_stig_v254316_result.changed | default(false) }}"
      - rule_id: "V-254317"
        rule_title: "Configure network access - Shares accessible anonymously"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "None (empty)"
        current_value: "None (empty)"
        status: "PASS"
        changed: "{{ windows_server_stig_v254317_result.changed | default(false) }}"
      - rule_id: "V-254318"
        rule_title: "Configure network access - Sharing and security model for local accounts"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Classic"
        current_value: "Classic"
        status: "PASS"
        changed: "{{ windows_server_stig_v254318_result.changed | default(false) }}"

- name: STIG | Display security options configuration summary (batch 5)
  ansible.builtin.debug:
    msg:
      - "==========================================="
      - "DISA STIG Security Options Configuration (Batch 5)"
      - "==========================================="
      - "V-254299: UAC Virtualization = Enabled"
      - "V-254300: Locked Session Info = No user info displayed"
      - "V-254301: Cached Logons = 4 or fewer"
      - "V-254302: Password Expiry Warning = 14 days"
      - "V-254303: CTRL+ALT+DEL Required = Enabled"
      - "V-254304: Smart Card Removal = Lock workstation"
      - "V-254305: Client Digital Signing (Always) = Enabled"
      - "V-254306: Client Digital Signing (If agreed) = Enabled"
      - "V-254307: Unencrypted SMB Passwords = Disabled"
      - "V-254308: Server Idle Time = 15 minutes"
      - "V-254309: Server Digital Signing (Always) = Enabled"
      - "V-254310: Server Digital Signing (If agreed) = Enabled"
      - "V-254311: Forced Logoff = Enabled"
      - "V-254312: Anonymous SID Translation = Disabled"
      - "V-254313: Credential Storage = Disabled"
      - "V-254314: Everyone Includes Anonymous = Disabled"
      - "V-254315: Anonymous Named Pipes/Shares = Restricted"
      - "V-254316: Remote SAM Calls = Restricted to Admins"
      - "V-254317: Anonymous Shares = None"
      - "V-254318: Local Account Model = Classic"
      - ""
      - "NOTE: Batch 5 complete - 20 additional Security Options controls"
      - "Total Security Options: 60/92 controls implemented (65%)"
      - "==========================================="
  tags:
    - security_options
    - stig