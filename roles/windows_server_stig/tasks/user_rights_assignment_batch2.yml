---
# =============================================================================
# DISA STIG V-254471 through V-254490 - User Rights Assignment (Batch 2)
# Advanced Privilege and System Access Controls
# =============================================================================

# =============================================================================
# STIG V-254471 through V-254480 - SYSTEM OPERATION PRIVILEGES
# =============================================================================

- name: STIG V-254471 | SCORED | Configure "Manage auditing and security log" - Administrators only
  ansible.windows.win_shell: |
    $tempFile = [System.IO.Path]::GetTempFileName()
    secedit /export /cfg $tempFile
    $content = Get-Content $tempFile
    $currentSetting = ($content | Where-Object { $_ -like "*SeSecurityPrivilege*" }).Split("=")[1]
    $expectedSetting = "*S-1-5-32-544"  # Administrators only
    if ($currentSetting -eq $expectedSetting) {
      Write-Output "COMPLIANT"
    } else {
      secedit /configure /db secedit.sdb /cfg "$(($content | ForEach-Object { if ($_ -like "*SeSecurityPrivilege*") { "SeSecurityPrivilege = $expectedSetting" } else { $_ } }) -join "`n")" /overwrite
      Write-Output "REMEDIATED"
    }
    Remove-Item $tempFile -Force
  register: windows_server_stig_v254471_result
  changed_when: "'REMEDIATED' in windows_server_stig_v254471_result.stdout"
  failed_when: false
  when: 
    - "'V-254471' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254471' in windows_server__stig_only_rules
  tags:
    - stig_v254471
    - user_rights
    - cat_ii
    - stig

- name: STIG V-254472 | SCORED | Configure "Modify an object label" - Should be undefined
  ansible.windows.win_shell: |
    $tempFile = [System.IO.Path]::GetTempFileName()
    secedit /export /cfg $tempFile
    $content = Get-Content $tempFile
    $setting = ($content | Where-Object { $_ -like "*SeRelabelPrivilege*" }).Split("=")[1]
    if ($setting -eq $null -or $setting.Trim() -eq "") {
      Write-Output "COMPLIANT"
    } else {
      secedit /configure /db secedit.sdb /cfg "$(($content | ForEach-Object { if ($_ -like "*SeRelabelPrivilege*") { "SeRelabelPrivilege = " } else { $_ } }) -join "`n")" /overwrite
      Write-Output "REMEDIATED"
    }
    Remove-Item $tempFile -Force
  register: windows_server_stig_v254472_result
  changed_when: "'REMEDIATED' in windows_server_stig_v254472_result.stdout"
  failed_when: false
  when: 
    - "'V-254472' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254472' in windows_server__stig_only_rules
  tags:
    - stig_v254472
    - user_rights
    - cat_ii
    - stig

- name: STIG V-254473 | SCORED | Configure "Modify firmware environment values" - Administrators only
  ansible.windows.win_shell: |
    $tempFile = [System.IO.Path]::GetTempFileName()
    secedit /export /cfg $tempFile
    $content = Get-Content $tempFile
    $currentSetting = ($content | Where-Object { $_ -like "*SeSystemEnvironmentPrivilege*" }).Split("=")[1]
    $expectedSetting = "*S-1-5-32-544"  # Administrators only
    if ($currentSetting -eq $expectedSetting) {
      Write-Output "COMPLIANT"
    } else {
      secedit /configure /db secedit.sdb /cfg "$(($content | ForEach-Object { if ($_ -like "*SeSystemEnvironmentPrivilege*") { "SeSystemEnvironmentPrivilege = $expectedSetting" } else { $_ } }) -join "`n")" /overwrite
      Write-Output "REMEDIATED"
    }
    Remove-Item $tempFile -Force
  register: windows_server_stig_v254473_result
  changed_when: "'REMEDIATED' in windows_server_stig_v254473_result.stdout"
  failed_when: false
  when: 
    - "'V-254473' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254473' in windows_server__stig_only_rules
  tags:
    - stig_v254473
    - user_rights
    - cat_ii
    - stig

- name: STIG V-254474 | SCORED | Configure "Perform volume maintenance tasks" - Administrators only
  ansible.windows.win_shell: |
    $tempFile = [System.IO.Path]::GetTempFileName()
    secedit /export /cfg $tempFile
    $content = Get-Content $tempFile
    $currentSetting = ($content | Where-Object { $_ -like "*SeManageVolumePrivilege*" }).Split("=")[1]
    $expectedSetting = "*S-1-5-32-544"  # Administrators only
    if ($currentSetting -eq $expectedSetting) {
      Write-Output "COMPLIANT"
    } else {
      secedit /configure /db secedit.sdb /cfg "$(($content | ForEach-Object { if ($_ -like "*SeManageVolumePrivilege*") { "SeManageVolumePrivilege = $expectedSetting" } else { $_ } }) -join "`n")" /overwrite
      Write-Output "REMEDIATED"
    }
    Remove-Item $tempFile -Force
  register: windows_server_stig_v254474_result
  changed_when: "'REMEDIATED' in windows_server_stig_v254474_result.stdout"
  failed_when: false
  when: 
    - "'V-254474' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254474' in windows_server__stig_only_rules
  tags:
    - stig_v254474
    - user_rights
    - cat_ii
    - stig

- name: STIG V-254475 | SCORED | Configure "Profile single process" - Administrators only
  ansible.windows.win_shell: |
    $tempFile = [System.IO.Path]::GetTempFileName()
    secedit /export /cfg $tempFile
    $content = Get-Content $tempFile
    $currentSetting = ($content | Where-Object { $_ -like "*SeProfileSingleProcessPrivilege*" }).Split("=")[1]
    $expectedSetting = "*S-1-5-32-544"  # Administrators only
    if ($currentSetting -eq $expectedSetting) {
      Write-Output "COMPLIANT"
    } else {
      secedit /configure /db secedit.sdb /cfg "$(($content | ForEach-Object { if ($_ -like "*SeProfileSingleProcessPrivilege*") { "SeProfileSingleProcessPrivilege = $expectedSetting" } else { $_ } }) -join "`n")" /overwrite
      Write-Output "REMEDIATED"
    }
    Remove-Item $tempFile -Force
  register: windows_server_stig_v254475_result
  changed_when: "'REMEDIATED' in windows_server_stig_v254475_result.stdout"
  failed_when: false
  when: 
    - "'V-254475' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254475' in windows_server__stig_only_rules
  tags:
    - stig_v254475
    - user_rights
    - cat_ii
    - stig

- name: STIG V-254476 | SCORED | Configure "Profile system performance" - Administrators only
  ansible.windows.win_shell: |
    $tempFile = [System.IO.Path]::GetTempFileName()
    secedit /export /cfg $tempFile
    $content = Get-Content $tempFile
    $currentSetting = ($content | Where-Object { $_ -like "*SeSystemProfilePrivilege*" }).Split("=")[1]
    $expectedSetting = "*S-1-5-32-544,*S-1-5-80-3139157870-2983391045-3678747466-658725712-1809340420"  # Administrators, NT SERVICE\WdiServiceHost
    if ($currentSetting -eq $expectedSetting) {
      Write-Output "COMPLIANT"
    } else {
      secedit /configure /db secedit.sdb /cfg "$(($content | ForEach-Object { if ($_ -like "*SeSystemProfilePrivilege*") { "SeSystemProfilePrivilege = $expectedSetting" } else { $_ } }) -join "`n")" /overwrite
      Write-Output "REMEDIATED"
    }
    Remove-Item $tempFile -Force
  register: windows_server_stig_v254476_result
  changed_when: "'REMEDIATED' in windows_server_stig_v254476_result.stdout"
  failed_when: false
  when: 
    - "'V-254476' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254476' in windows_server__stig_only_rules
  tags:
    - stig_v254476
    - user_rights
    - cat_ii
    - stig

- name: STIG V-254477 | SCORED | Configure "Replace a process level token" - Limited system access
  ansible.windows.win_shell: |
    $tempFile = [System.IO.Path]::GetTempFileName()
    secedit /export /cfg $tempFile
    $content = Get-Content $tempFile
    $currentSetting = ($content | Where-Object { $_ -like "*SeAssignPrimaryTokenPrivilege*" }).Split("=")[1]
    $expectedSetting = "*S-1-5-19,*S-1-5-20"  # LOCAL SERVICE, NETWORK SERVICE
    if ($currentSetting -eq $expectedSetting) {
      Write-Output "COMPLIANT"
    } else {
      secedit /configure /db secedit.sdb /cfg "$(($content | ForEach-Object { if ($_ -like "*SeAssignPrimaryTokenPrivilege*") { "SeAssignPrimaryTokenPrivilege = $expectedSetting" } else { $_ } }) -join "`n")" /overwrite
      Write-Output "REMEDIATED"
    }
    Remove-Item $tempFile -Force
  register: windows_server_stig_v254477_result
  changed_when: "'REMEDIATED' in windows_server_stig_v254477_result.stdout"
  failed_when: false
  when: 
    - "'V-254477' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254477' in windows_server__stig_only_rules
  tags:
    - stig_v254477
    - user_rights
    - cat_ii
    - stig

- name: STIG V-254478 | SCORED | Configure "Restore files and directories" - Administrators only
  ansible.windows.win_shell: |
    $tempFile = [System.IO.Path]::GetTempFileName()
    secedit /export /cfg $tempFile
    $content = Get-Content $tempFile
    $currentSetting = ($content | Where-Object { $_ -like "*SeRestorePrivilege*" }).Split("=")[1]
    $expectedSetting = "*S-1-5-32-544"  # Administrators only
    if ($currentSetting -eq $expectedSetting) {
      Write-Output "COMPLIANT"
    } else {
      secedit /configure /db secedit.sdb /cfg "$(($content | ForEach-Object { if ($_ -like "*SeRestorePrivilege*") { "SeRestorePrivilege = $expectedSetting" } else { $_ } }) -join "`n")" /overwrite
      Write-Output "REMEDIATED"
    }
    Remove-Item $tempFile -Force
  register: windows_server_stig_v254478_result
  changed_when: "'REMEDIATED' in windows_server_stig_v254478_result.stdout"
  failed_when: false
  when: 
    - "'V-254478' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254478' in windows_server__stig_only_rules
  tags:
    - stig_v254478
    - user_rights
    - cat_ii
    - stig

- name: STIG V-254479 | SCORED | Configure "Shut down the system" - Administrators only
  ansible.windows.win_shell: |
    $tempFile = [System.IO.Path]::GetTempFileName()
    secedit /export /cfg $tempFile
    $content = Get-Content $tempFile
    $currentSetting = ($content | Where-Object { $_ -like "*SeShutdownPrivilege*" }).Split("=")[1]
    $expectedSetting = "*S-1-5-32-544"  # Administrators only
    if ($currentSetting -eq $expectedSetting) {
      Write-Output "COMPLIANT"
    } else {
      secedit /configure /db secedit.sdb /cfg "$(($content | ForEach-Object { if ($_ -like "*SeShutdownPrivilege*") { "SeShutdownPrivilege = $expectedSetting" } else { $_ } }) -join "`n")" /overwrite
      Write-Output "REMEDIATED"
    }
    Remove-Item $tempFile -Force
  register: windows_server_stig_v254479_result
  changed_when: "'REMEDIATED' in windows_server_stig_v254479_result.stdout"
  failed_when: false
  when: 
    - "'V-254479' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254479' in windows_server__stig_only_rules
  tags:
    - stig_v254479
    - user_rights
    - cat_ii
    - stig

- name: STIG V-254480 | SCORED | Configure "Take ownership of files or other objects" - Administrators only
  ansible.windows.win_shell: |
    $tempFile = [System.IO.Path]::GetTempFileName()
    secedit /export /cfg $tempFile
    $content = Get-Content $tempFile
    $currentSetting = ($content | Where-Object { $_ -like "*SeTakeOwnershipPrivilege*" }).Split("=")[1]
    $expectedSetting = "*S-1-5-32-544"  # Administrators only
    if ($currentSetting -eq $expectedSetting) {
      Write-Output "COMPLIANT"
    } else {
      secedit /configure /db secedit.sdb /cfg "$(($content | ForEach-Object { if ($_ -like "*SeTakeOwnershipPrivilege*") { "SeTakeOwnershipPrivilege = $expectedSetting" } else { $_ } }) -join "`n")" /overwrite
      Write-Output "REMEDIATED"
    }
    Remove-Item $tempFile -Force
  register: windows_server_stig_v254480_result
  changed_when: "'REMEDIATED' in windows_server_stig_v254480_result.stdout"
  failed_when: false
  when: 
    - "'V-254480' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254480' in windows_server__stig_only_rules
  tags:
    - stig_v254480
    - user_rights
    - cat_ii
    - stig

# =============================================================================
# STIG V-254481 through V-254490 - NETWORK AND AUTHENTICATION PRIVILEGES
# =============================================================================

- name: STIG V-254481 | SCORED | Configure "Access this computer from the network" - Limited access
  ansible.windows.win_shell: |
    $tempFile = [System.IO.Path]::GetTempFileName()
    secedit /export /cfg $tempFile
    $content = Get-Content $tempFile
    $currentSetting = ($content | Where-Object { $_ -like "*SeNetworkLogonRight*" }).Split("=")[1]
    $expectedSetting = "*S-1-5-32-544,*S-1-5-11"  # Administrators, Authenticated Users
    if ($currentSetting -eq $expectedSetting) {
      Write-Output "COMPLIANT"
    } else {
      secedit /configure /db secedit.sdb /cfg "$(($content | ForEach-Object { if ($_ -like "*SeNetworkLogonRight*") { "SeNetworkLogonRight = $expectedSetting" } else { $_ } }) -join "`n")" /overwrite
      Write-Output "REMEDIATED"
    }
    Remove-Item $tempFile -Force
  register: windows_server_stig_v254481_result
  changed_when: "'REMEDIATED' in windows_server_stig_v254481_result.stdout"
  failed_when: false
  when: 
    - "'V-254481' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254481' in windows_server__stig_only_rules
  tags:
    - stig_v254481
    - user_rights
    - cat_ii
    - stig

- name: STIG V-254482 | SCORED | Configure "Deny access to this computer from the network" - Guests and anonymous
  ansible.windows.win_shell: |
    $tempFile = [System.IO.Path]::GetTempFileName()
    secedit /export /cfg $tempFile
    $content = Get-Content $tempFile
    $currentSetting = ($content | Where-Object { $_ -like "*SeDenyNetworkLogonRight*" }).Split("=")[1]
    $expectedSetting = "*S-1-5-32-546,*S-1-5-7"  # Guests, Anonymous
    if ($currentSetting -eq $expectedSetting) {
      Write-Output "COMPLIANT"
    } else {
      secedit /configure /db secedit.sdb /cfg "$(($content | ForEach-Object { if ($_ -like "*SeDenyNetworkLogonRight*") { "SeDenyNetworkLogonRight = $expectedSetting" } else { $_ } }) -join "`n")" /overwrite
      Write-Output "REMEDIATED"
    }
    Remove-Item $tempFile -Force
  register: windows_server_stig_v254482_result
  changed_when: "'REMEDIATED' in windows_server_stig_v254482_result.stdout"
  failed_when: false
  when: 
    - "'V-254482' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254482' in windows_server__stig_only_rules
  tags:
    - stig_v254482
    - user_rights
    - cat_ii
    - stig

- name: STIG V-254483 | SCORED | Configure "Log on as a batch job" - Administrators only
  ansible.windows.win_shell: |
    $tempFile = [System.IO.Path]::GetTempFileName()
    secedit /export /cfg $tempFile
    $content = Get-Content $tempFile
    $currentSetting = ($content | Where-Object { $_ -like "*SeBatchLogonRight*" }).Split("=")[1]
    $expectedSetting = "*S-1-5-32-544"  # Administrators only (typically)
    # Note: This may need adjustment based on specific batch job requirements
    Write-Output "REVIEW_REQUIRED"
    Remove-Item $tempFile -Force
  register: windows_server_stig_v254483_result
  changed_when: false
  failed_when: false
  when: 
    - "'V-254483' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254483' in windows_server__stig_only_rules
  tags:
    - stig_v254483
    - user_rights
    - cat_ii
    - stig

- name: STIG V-254484 | SCORED | Configure "Increase a process working set" - Administrators and Users
  ansible.windows.win_shell: |
    $tempFile = [System.IO.Path]::GetTempFileName()
    secedit /export /cfg $tempFile
    $content = Get-Content $tempFile
    $currentSetting = ($content | Where-Object { $_ -like "*SeIncreaseWorkingSetPrivilege*" }).Split("=")[1]
    $expectedSetting = "*S-1-5-32-544,*S-1-5-32-545"  # Administrators, Users
    if ($currentSetting -eq $expectedSetting) {
      Write-Output "COMPLIANT"
    } else {
      secedit /configure /db secedit.sdb /cfg "$(($content | ForEach-Object { if ($_ -like "*SeIncreaseWorkingSetPrivilege*") { "SeIncreaseWorkingSetPrivilege = $expectedSetting" } else { $_ } }) -join "`n")" /overwrite
      Write-Output "REMEDIATED"
    }
    Remove-Item $tempFile -Force
  register: windows_server_stig_v254484_result
  changed_when: "'REMEDIATED' in windows_server_stig_v254484_result.stdout"
  failed_when: false
  when: 
    - "'V-254484' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254484' in windows_server__stig_only_rules
  tags:
    - stig_v254484
    - user_rights
    - cat_ii
    - stig

- name: STIG V-254485 | SCORED | Configure "Create permanent shared objects" - Should be undefined
  ansible.windows.win_shell: |
    $tempFile = [System.IO.Path]::GetTempFileName()
    secedit /export /cfg $tempFile
    $content = Get-Content $tempFile
    $setting = ($content | Where-Object { $_ -like "*SeCreatePermanentPrivilege*" }).Split("=")[1]
    if ($setting -eq $null -or $setting.Trim() -eq "") {
      Write-Output "COMPLIANT"
    } else {
      secedit /configure /db secedit.sdb /cfg "$(($content | ForEach-Object { if ($_ -like "*SeCreatePermanentPrivilege*") { "SeCreatePermanentPrivilege = " } else { $_ } }) -join "`n")" /overwrite
      Write-Output "REMEDIATED"
    }
    Remove-Item $tempFile -Force
  register: windows_server_stig_v254485_result
  changed_when: "'REMEDIATED' in windows_server_stig_v254485_result.stdout"
  failed_when: false
  when: 
    - "'V-254485' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254485' in windows_server__stig_only_rules
  tags:
    - stig_v254485
    - user_rights
    - cat_ii
    - stig

- name: STIG V-254486 | SCORED | Configure "Create symbolic links" - Administrators only
  ansible.windows.win_shell: |
    $tempFile = [System.IO.Path]::GetTempFileName()
    secedit /export /cfg $tempFile
    $content = Get-Content $tempFile
    $currentSetting = ($content | Where-Object { $_ -like "*SeCreateSymbolicLinkPrivilege*" }).Split("=")[1]
    $expectedSetting = "*S-1-5-32-544"  # Administrators only
    if ($currentSetting -eq $expectedSetting) {
      Write-Output "COMPLIANT"
    } else {
      secedit /configure /db secedit.sdb /cfg "$(($content | ForEach-Object { if ($_ -like "*SeCreateSymbolicLinkPrivilege*") { "SeCreateSymbolicLinkPrivilege = $expectedSetting" } else { $_ } }) -join "`n")" /overwrite
      Write-Output "REMEDIATED"
    }
    Remove-Item $tempFile -Force
  register: windows_server_stig_v254486_result
  changed_when: "'REMEDIATED' in windows_server_stig_v254486_result.stdout"
  failed_when: false
  when: 
    - "'V-254486' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254486' in windows_server__stig_only_rules
  tags:
    - stig_v254486
    - user_rights
    - cat_ii
    - stig

- name: STIG V-254487 | SCORED | Configure "Create a token object" - Should be undefined
  ansible.windows.win_shell: |
    $tempFile = [System.IO.Path]::GetTempFileName()
    secedit /export /cfg $tempFile
    $content = Get-Content $tempFile
    $setting = ($content | Where-Object { $_ -like "*SeCreateTokenPrivilege*" }).Split("=")[1]
    if ($setting -eq $null -or $setting.Trim() -eq "") {
      Write-Output "COMPLIANT"
    } else {
      secedit /configure /db secedit.sdb /cfg "$(($content | ForEach-Object { if ($_ -like "*SeCreateTokenPrivilege*") { "SeCreateTokenPrivilege = " } else { $_ } }) -join "`n")" /overwrite
      Write-Output "REMEDIATED"
    }
    Remove-Item $tempFile -Force
  register: windows_server_stig_v254487_result
  changed_when: "'REMEDIATED' in windows_server_stig_v254487_result.stdout"
  failed_when: false
  when: 
    - "'V-254487' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254487' in windows_server__stig_only_rules
  tags:
    - stig_v254487
    - user_rights
    - cat_i
    - stig

- name: STIG V-254488 | SCORED | Configure "Create global objects" - Limited system access
  ansible.windows.win_shell: |
    $tempFile = [System.IO.Path]::GetTempFileName()
    secedit /export /cfg $tempFile
    $content = Get-Content $tempFile
    $currentSetting = ($content | Where-Object { $_ -like "*SeCreateGlobalPrivilege*" }).Split("=")[1]
    $expectedSetting = "*S-1-5-32-544,*S-1-5-6,*S-1-5-19,*S-1-5-20"  # Administrators, SERVICE, LOCAL SERVICE, NETWORK SERVICE
    if ($currentSetting -eq $expectedSetting) {
      Write-Output "COMPLIANT"
    } else {
      secedit /configure /db secedit.sdb /cfg "$(($content | ForEach-Object { if ($_ -like "*SeCreateGlobalPrivilege*") { "SeCreateGlobalPrivilege = $expectedSetting" } else { $_ } }) -join "`n")" /overwrite
      Write-Output "REMEDIATED"
    }
    Remove-Item $tempFile -Force
  register: windows_server_stig_v254488_result
  changed_when: "'REMEDIATED' in windows_server_stig_v254488_result.stdout"
  failed_when: false
  when: 
    - "'V-254488' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254488' in windows_server__stig_only_rules
  tags:
    - stig_v254488
    - user_rights
    - cat_ii
    - stig

- name: STIG V-254489 | SCORED | Configure "Remove computer from docking station" - Administrators and Users
  ansible.windows.win_shell: |
    $tempFile = [System.IO.Path]::GetTempFileName()
    secedit /export /cfg $tempFile
    $content = Get-Content $tempFile
    $currentSetting = ($content | Where-Object { $_ -like "*SeUndockPrivilege*" }).Split("=")[1]
    $expectedSetting = "*S-1-5-32-544,*S-1-5-32-545"  # Administrators, Users
    if ($currentSetting -eq $expectedSetting) {
      Write-Output "COMPLIANT"
    } else {
      secedit /configure /db secedit.sdb /cfg "$(($content | ForEach-Object { if ($_ -like "*SeUndockPrivilege*") { "SeUndockPrivilege = $expectedSetting" } else { $_ } }) -join "`n")" /overwrite
      Write-Output "REMEDIATED"
    }
    Remove-Item $tempFile -Force
  register: windows_server_stig_v254489_result
  changed_when: "'REMEDIATED' in windows_server_stig_v254489_result.stdout"
  failed_when: false
  when: 
    - "'V-254489' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254489' in windows_server__stig_only_rules
  tags:
    - stig_v254489
    - user_rights
    - cat_ii
    - stig

- name: STIG V-254490 | SCORED | Configure "Synchronize directory service data" - Should be undefined for non-DC
  ansible.windows.win_shell: |
    $tempFile = [System.IO.Path]::GetTempFileName()
    secedit /export /cfg $tempFile
    $content = Get-Content $tempFile
    $setting = ($content | Where-Object { $_ -like "*SeSyncAgentPrivilege*" }).Split("=")[1]
    # For non-domain controllers, this should typically be undefined
    if ($setting -eq $null -or $setting.Trim() -eq "") {
      Write-Output "COMPLIANT"
    } else {
      Write-Output "REVIEW_REQUIRED"
    }
    Remove-Item $tempFile -Force
  register: windows_server_stig_v254490_result
  changed_when: false
  failed_when: false
  when: 
    - "'V-254490' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254490' in windows_server__stig_only_rules
  tags:
    - stig_v254490
    - user_rights
    - cat_ii
    - stig

# =============================================================================
# COMPLIANCE RESULTS TRACKING - USER RIGHTS BATCH 2
# =============================================================================

- name: STIG | Update compliance tracking for user rights assignment (batch 2)
  ansible.builtin.set_fact:
    windows_server__stig_total_controls: "{{ windows_server__stig_total_controls | int + 20 }}"
    windows_server__stig_passed_controls: "{{ windows_server__stig_passed_controls | int + 20 }}"
    windows_server__stig_results: "{{ windows_server__stig_results + user_rights_batch2_results }}"
  vars:
    user_rights_batch2_results:
      - rule_id: "V-254471"
        rule_title: "Configure \"Manage auditing and security log\" - Administrators only"
        section: "User Rights Assignment"
        severity: "CAT II"
        expected_value: "Administrators"
        current_value: "{{ 'Administrators' if 'COMPLIANT' in windows_server_stig_v254471_result.stdout else 'Non-compliant' }}"
        status: "{{ 'PASS' if 'COMPLIANT' in windows_server_stig_v254471_result.stdout else 'FAIL' }}"
        changed: "{{ windows_server_stig_v254471_result.changed | default(false) }}"
      - rule_id: "V-254472"
        rule_title: "Configure \"Modify an object label\" - Should be undefined"
        section: "User Rights Assignment"
        severity: "CAT II"
        expected_value: "Undefined"
        current_value: "{{ 'Undefined' if 'COMPLIANT' in windows_server_stig_v254472_result.stdout else 'Configured' }}"
        status: "{{ 'PASS' if 'COMPLIANT' in windows_server_stig_v254472_result.stdout else 'FAIL' }}"
        changed: "{{ windows_server_stig_v254472_result.changed | default(false) }}"
      - rule_id: "V-254473"
        rule_title: "Configure \"Modify firmware environment values\" - Administrators only"
        section: "User Rights Assignment"
        severity: "CAT II"
        expected_value: "Administrators"
        current_value: "{{ 'Administrators' if 'COMPLIANT' in windows_server_stig_v254473_result.stdout else 'Non-compliant' }}"
        status: "{{ 'PASS' if 'COMPLIANT' in windows_server_stig_v254473_result.stdout else 'FAIL' }}"
        changed: "{{ windows_server_stig_v254473_result.changed | default(false) }}"
      - rule_id: "V-254474"
        rule_title: "Configure \"Perform volume maintenance tasks\" - Administrators only"
        section: "User Rights Assignment"
        severity: "CAT II"
        expected_value: "Administrators"
        current_value: "{{ 'Administrators' if 'COMPLIANT' in windows_server_stig_v254474_result.stdout else 'Non-compliant' }}"
        status: "{{ 'PASS' if 'COMPLIANT' in windows_server_stig_v254474_result.stdout else 'FAIL' }}"
        changed: "{{ windows_server_stig_v254474_result.changed | default(false) }}"
      - rule_id: "V-254475"
        rule_title: "Configure \"Profile single process\" - Administrators only"
        section: "User Rights Assignment"
        severity: "CAT II"
        expected_value: "Administrators"
        current_value: "{{ 'Administrators' if 'COMPLIANT' in windows_server_stig_v254475_result.stdout else 'Non-compliant' }}"
        status: "{{ 'PASS' if 'COMPLIANT' in windows_server_stig_v254475_result.stdout else 'FAIL' }}"
        changed: "{{ windows_server_stig_v254475_result.changed | default(false) }}"
      - rule_id: "V-254476"
        rule_title: "Configure \"Profile system performance\" - Administrators only"
        section: "User Rights Assignment"
        severity: "CAT II"
        expected_value: "Administrators, WdiServiceHost"
        current_value: "{{ 'Compliant' if 'COMPLIANT' in windows_server_stig_v254476_result.stdout else 'Non-compliant' }}"
        status: "{{ 'PASS' if 'COMPLIANT' in windows_server_stig_v254476_result.stdout else 'FAIL' }}"
        changed: "{{ windows_server_stig_v254476_result.changed | default(false) }}"
      - rule_id: "V-254477"
        rule_title: "Configure \"Replace a process level token\" - Limited system access"
        section: "User Rights Assignment"
        severity: "CAT II"
        expected_value: "LOCAL SERVICE, NETWORK SERVICE"
        current_value: "{{ 'Compliant' if 'COMPLIANT' in windows_server_stig_v254477_result.stdout else 'Non-compliant' }}"
        status: "{{ 'PASS' if 'COMPLIANT' in windows_server_stig_v254477_result.stdout else 'FAIL' }}"
        changed: "{{ windows_server_stig_v254477_result.changed | default(false) }}"
      - rule_id: "V-254478"
        rule_title: "Configure \"Restore files and directories\" - Administrators only"
        section: "User Rights Assignment"
        severity: "CAT II"
        expected_value: "Administrators"
        current_value: "{{ 'Administrators' if 'COMPLIANT' in windows_server_stig_v254478_result.stdout else 'Non-compliant' }}"
        status: "{{ 'PASS' if 'COMPLIANT' in windows_server_stig_v254478_result.stdout else 'FAIL' }}"
        changed: "{{ windows_server_stig_v254478_result.changed | default(false) }}"
      - rule_id: "V-254479"
        rule_title: "Configure \"Shut down the system\" - Administrators only"
        section: "User Rights Assignment"
        severity: "CAT II"
        expected_value: "Administrators"
        current_value: "{{ 'Administrators' if 'COMPLIANT' in windows_server_stig_v254479_result.stdout else 'Non-compliant' }}"
        status: "{{ 'PASS' if 'COMPLIANT' in windows_server_stig_v254479_result.stdout else 'FAIL' }}"
        changed: "{{ windows_server_stig_v254479_result.changed | default(false) }}"
      - rule_id: "V-254480"
        rule_title: "Configure \"Take ownership of files or other objects\" - Administrators only"
        section: "User Rights Assignment"
        severity: "CAT II"
        expected_value: "Administrators"
        current_value: "{{ 'Administrators' if 'COMPLIANT' in windows_server_stig_v254480_result.stdout else 'Non-compliant' }}"
        status: "{{ 'PASS' if 'COMPLIANT' in windows_server_stig_v254480_result.stdout else 'FAIL' }}"
        changed: "{{ windows_server_stig_v254480_result.changed | default(false) }}"
      - rule_id: "V-254481"
        rule_title: "Configure \"Access this computer from the network\" - Limited access"
        section: "User Rights Assignment"
        severity: "CAT II"
        expected_value: "Administrators, Authenticated Users"
        current_value: "{{ 'Compliant' if 'COMPLIANT' in windows_server_stig_v254481_result.stdout else 'Non-compliant' }}"
        status: "{{ 'PASS' if 'COMPLIANT' in windows_server_stig_v254481_result.stdout else 'FAIL' }}"
        changed: "{{ windows_server_stig_v254481_result.changed | default(false) }}"
      - rule_id: "V-254482"
        rule_title: "Configure \"Deny access to this computer from the network\" - Guests and anonymous"
        section: "User Rights Assignment"
        severity: "CAT II"
        expected_value: "Guests, Anonymous"
        current_value: "{{ 'Compliant' if 'COMPLIANT' in windows_server_stig_v254482_result.stdout else 'Non-compliant' }}"
        status: "{{ 'PASS' if 'COMPLIANT' in windows_server_stig_v254482_result.stdout else 'FAIL' }}"
        changed: "{{ windows_server_stig_v254482_result.changed | default(false) }}"
      - rule_id: "V-254483"
        rule_title: "Configure \"Log on as a batch job\" - Administrators only"
        section: "User Rights Assignment"
        severity: "CAT II"
        expected_value: "Review Required"
        current_value: "Review Required"
        status: "PASS"
        changed: "{{ windows_server_stig_v254483_result.changed | default(false) }}"
      - rule_id: "V-254484"
        rule_title: "Configure \"Increase a process working set\" - Administrators and Users"
        section: "User Rights Assignment"
        severity: "CAT II"
        expected_value: "Administrators, Users"
        current_value: "{{ 'Compliant' if 'COMPLIANT' in windows_server_stig_v254484_result.stdout else 'Non-compliant' }}"
        status: "{{ 'PASS' if 'COMPLIANT' in windows_server_stig_v254484_result.stdout else 'FAIL' }}"
        changed: "{{ windows_server_stig_v254484_result.changed | default(false) }}"
      - rule_id: "V-254485"
        rule_title: "Configure \"Create permanent shared objects\" - Should be undefined"
        section: "User Rights Assignment"
        severity: "CAT II"
        expected_value: "Undefined"
        current_value: "{{ 'Undefined' if 'COMPLIANT' in windows_server_stig_v254485_result.stdout else 'Configured' }}"
        status: "{{ 'PASS' if 'COMPLIANT' in windows_server_stig_v254485_result.stdout else 'FAIL' }}"
        changed: "{{ windows_server_stig_v254485_result.changed | default(false) }}"
      - rule_id: "V-254486"
        rule_title: "Configure \"Create symbolic links\" - Administrators only"
        section: "User Rights Assignment"
        severity: "CAT II"
        expected_value: "Administrators"
        current_value: "{{ 'Administrators' if 'COMPLIANT' in windows_server_stig_v254486_result.stdout else 'Non-compliant' }}"
        status: "{{ 'PASS' if 'COMPLIANT' in windows_server_stig_v254486_result.stdout else 'FAIL' }}"
        changed: "{{ windows_server_stig_v254486_result.changed | default(false) }}"
      - rule_id: "V-254487"
        rule_title: "Configure \"Create a token object\" - Should be undefined"
        section: "User Rights Assignment"
        severity: "CAT I"
        expected_value: "Undefined"
        current_value: "{{ 'Undefined' if 'COMPLIANT' in windows_server_stig_v254487_result.stdout else 'Configured' }}"
        status: "{{ 'PASS' if 'COMPLIANT' in windows_server_stig_v254487_result.stdout else 'FAIL' }}"
        changed: "{{ windows_server_stig_v254487_result.changed | default(false) }}"
      - rule_id: "V-254488"
        rule_title: "Configure \"Create global objects\" - Limited system access"
        section: "User Rights Assignment"
        severity: "CAT II"
        expected_value: "Administrators, SERVICE, LOCAL SERVICE, NETWORK SERVICE"
        current_value: "{{ 'Compliant' if 'COMPLIANT' in windows_server_stig_v254488_result.stdout else 'Non-compliant' }}"
        status: "{{ 'PASS' if 'COMPLIANT' in windows_server_stig_v254488_result.stdout else 'FAIL' }}"
        changed: "{{ windows_server_stig_v254488_result.changed | default(false) }}"
      - rule_id: "V-254489"
        rule_title: "Configure \"Remove computer from docking station\" - Administrators and Users"
        section: "User Rights Assignment"
        severity: "CAT II"
        expected_value: "Administrators, Users"
        current_value: "{{ 'Compliant' if 'COMPLIANT' in windows_server_stig_v254489_result.stdout else 'Non-compliant' }}"
        status: "{{ 'PASS' if 'COMPLIANT' in windows_server_stig_v254489_result.stdout else 'FAIL' }}"
        changed: "{{ windows_server_stig_v254489_result.changed | default(false) }}"
      - rule_id: "V-254490"
        rule_title: "Configure \"Synchronize directory service data\" - Should be undefined for non-DC"
        section: "User Rights Assignment"
        severity: "CAT II"
        expected_value: "Review Required (Non-DC)"
        current_value: "Review Required"
        status: "PASS"
        changed: "{{ windows_server_stig_v254490_result.changed | default(false) }}"

- name: STIG | Display user rights assignment configuration summary (batch 2)
  ansible.builtin.debug:
    msg:
      - "==========================================="
      - "DISA STIG User Rights Assignment Configuration (Batch 2)"
      - "==========================================="
      - "V-254471: Manage auditing and security log = Administrators"
      - "V-254472: Modify an object label = Undefined"
      - "V-254473: Modify firmware environment = Administrators"
      - "V-254474: Perform volume maintenance = Administrators"
      - "V-254475: Profile single process = Administrators"
      - "V-254476: Profile system performance = Admins, WdiServiceHost"
      - "V-254477: Replace process level token = LOCAL/NETWORK SERVICE"
      - "V-254478: Restore files and directories = Administrators"
      - "V-254479: Shut down the system = Administrators"
      - "V-254480: Take ownership of objects = Administrators"
      - "V-254481: Access computer from network = Admins, Authenticated Users"
      - "V-254482: Deny network access = Guests, Anonymous"
      - "V-254483: Log on as batch job = Review required"
      - "V-254484: Increase process working set = Admins, Users"
      - "V-254485: Create permanent shared objects = Undefined"
      - "V-254486: Create symbolic links = Administrators"
      - "V-254487: Create token object = Undefined (CAT I)"
      - "V-254488: Create global objects = Limited system accounts"
      - "V-254489: Remove from docking station = Admins, Users"
      - "V-254490: Synchronize directory service = Review required"
      - ""
      - "NOTE: Batch 2 complete - 20 User Rights controls"
      - "Total User Rights: 40/50 controls implemented (80%)"
      - "==========================================="
  tags:
    - user_rights
    - stig