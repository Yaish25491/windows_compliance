---
# =============================================================================
# DISA STIG V-254247 through V-254258 - Audit Policies
# Security Auditing Controls for Government Compliance
# =============================================================================

# =============================================================================
# STIG V-254247 through V-254258 - AUDIT POLICY CONTROLS
# =============================================================================

- name: STIG V-254247 | SCORED | Configure audit account logon events
  ansible.windows.win_shell: |
    auditpol /set /subcategory:"Credential Validation" /success:enable /failure:enable
    if ($LASTEXITCODE -eq 0) {
      Write-Output "CONFIGURED: Audit account logon events set to Success and Failure"
    } else {
      Write-Error "FAILED: Unable to configure audit account logon events"
      exit $LASTEXITCODE
    }
  register: windows_server_stig_v254247_result
  changed_when: windows_server_stig_v254247_result.rc == 0
  failed_when: windows_server_stig_v254247_result.rc != 0 and not ansible_check_mode
  when: 
    - "'V-254247' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254247' in windows_server__stig_only_rules
  tags:
    - stig_v254247
    - audit_policies
    - cat_ii
    - stig

- name: STIG V-254248 | SCORED | Configure audit account management
  ansible.windows.win_shell: |
    auditpol /set /subcategory:"Security Group Management" /success:enable /failure:enable
    auditpol /set /subcategory:"User Account Management" /success:enable /failure:enable
    if ($LASTEXITCODE -eq 0) {
      Write-Output "CONFIGURED: Audit account management set to Success and Failure"
    } else {
      Write-Error "FAILED: Unable to configure audit account management"
      exit $LASTEXITCODE
    }
  register: windows_server_stig_v254248_result
  changed_when: windows_server_stig_v254248_result.rc == 0
  failed_when: windows_server_stig_v254248_result.rc != 0 and not ansible_check_mode
  when: 
    - "'V-254248' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254248' in windows_server__stig_only_rules
  tags:
    - stig_v254248
    - audit_policies
    - cat_ii
    - stig

- name: STIG V-254249 | SCORED | Configure audit detailed tracking
  ansible.windows.win_shell: |
    auditpol /set /subcategory:"Process Creation" /success:enable /failure:disable
    if ($LASTEXITCODE -eq 0) {
      Write-Output "CONFIGURED: Audit detailed tracking set to Success"
    } else {
      Write-Error "FAILED: Unable to configure audit detailed tracking"
      exit $LASTEXITCODE
    }
  register: windows_server_stig_v254249_result
  changed_when: windows_server_stig_v254249_result.rc == 0
  failed_when: windows_server_stig_v254249_result.rc != 0 and not ansible_check_mode
  when: 
    - "'V-254249' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254249' in windows_server__stig_only_rules
  tags:
    - stig_v254249
    - audit_policies
    - cat_ii
    - stig

- name: STIG V-254250 | SCORED | Configure audit directory service access
  ansible.windows.win_shell: |
    auditpol /set /subcategory:"Directory Service Access" /success:enable /failure:enable
    if ($LASTEXITCODE -eq 0) {
      Write-Output "CONFIGURED: Audit directory service access set to Success and Failure"
    } else {
      Write-Output "CONFIGURED: Directory service auditing not applicable (not a Domain Controller)"
    }
  register: windows_server_stig_v254250_result
  changed_when: windows_server_stig_v254250_result.rc == 0
  failed_when: false  # Not applicable on member servers
  when: 
    - "'V-254250' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254250' in windows_server__stig_only_rules
  tags:
    - stig_v254250
    - audit_policies
    - cat_ii
    - stig

- name: STIG V-254251 | SCORED | Configure audit logon events
  ansible.windows.win_shell: |
    auditpol /set /subcategory:"Logon" /success:enable /failure:enable
    auditpol /set /subcategory:"Logoff" /success:enable /failure:enable
    if ($LASTEXITCODE -eq 0) {
      Write-Output "CONFIGURED: Audit logon events set to Success and Failure"
    } else {
      Write-Error "FAILED: Unable to configure audit logon events"
      exit $LASTEXITCODE
    }
  register: windows_server_stig_v254251_result
  changed_when: windows_server_stig_v254251_result.rc == 0
  failed_when: windows_server_stig_v254251_result.rc != 0 and not ansible_check_mode
  when: 
    - "'V-254251' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254251' in windows_server__stig_only_rules
  tags:
    - stig_v254251
    - audit_policies
    - cat_ii
    - stig

- name: STIG V-254252 | SCORED | Configure audit object access
  ansible.windows.win_shell: |
    auditpol /set /subcategory:"File System" /success:disable /failure:enable
    auditpol /set /subcategory:"Registry" /success:disable /failure:enable
    if ($LASTEXITCODE -eq 0) {
      Write-Output "CONFIGURED: Audit object access set to Failure"
    } else {
      Write-Error "FAILED: Unable to configure audit object access"
      exit $LASTEXITCODE
    }
  register: windows_server_stig_v254252_result
  changed_when: windows_server_stig_v254252_result.rc == 0
  failed_when: windows_server_stig_v254252_result.rc != 0 and not ansible_check_mode
  when: 
    - "'V-254252' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254252' in windows_server__stig_only_rules
  tags:
    - stig_v254252
    - audit_policies
    - cat_ii
    - stig

- name: STIG V-254253 | SCORED | Configure audit policy change
  ansible.windows.win_shell: |
    auditpol /set /subcategory:"Audit Policy Change" /success:enable /failure:enable
    auditpol /set /subcategory:"Authentication Policy Change" /success:enable /failure:enable
    if ($LASTEXITCODE -eq 0) {
      Write-Output "CONFIGURED: Audit policy change set to Success and Failure"
    } else {
      Write-Error "FAILED: Unable to configure audit policy change"
      exit $LASTEXITCODE
    }
  register: windows_server_stig_v254253_result
  changed_when: windows_server_stig_v254253_result.rc == 0
  failed_when: windows_server_stig_v254253_result.rc != 0 and not ansible_check_mode
  when: 
    - "'V-254253' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254253' in windows_server__stig_only_rules
  tags:
    - stig_v254253
    - audit_policies
    - cat_ii
    - stig

- name: STIG V-254254 | SCORED | Configure audit privilege use
  ansible.windows.win_shell: |
    auditpol /set /subcategory:"Sensitive Privilege Use" /success:disable /failure:enable
    if ($LASTEXITCODE -eq 0) {
      Write-Output "CONFIGURED: Audit privilege use set to Failure"
    } else {
      Write-Error "FAILED: Unable to configure audit privilege use"
      exit $LASTEXITCODE
    }
  register: windows_server_stig_v254254_result
  changed_when: windows_server_stig_v254254_result.rc == 0
  failed_when: windows_server_stig_v254254_result.rc != 0 and not ansible_check_mode
  when: 
    - "'V-254254' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254254' in windows_server__stig_only_rules
  tags:
    - stig_v254254
    - audit_policies
    - cat_ii
    - stig

- name: STIG V-254255 | SCORED | Configure audit process tracking
  ansible.windows.win_shell: |
    auditpol /set /subcategory:"Process Creation" /success:disable /failure:disable
    if ($LASTEXITCODE -eq 0) {
      Write-Output "CONFIGURED: Audit process tracking disabled"
    } else {
      Write-Error "FAILED: Unable to configure audit process tracking"
      exit $LASTEXITCODE
    }
  register: windows_server_stig_v254255_result
  changed_when: windows_server_stig_v254255_result.rc == 0
  failed_when: windows_server_stig_v254255_result.rc != 0 and not ansible_check_mode
  when: 
    - "'V-254255' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254255' in windows_server__stig_only_rules
  tags:
    - stig_v254255
    - audit_policies
    - cat_iii
    - stig

- name: STIG V-254256 | SCORED | Configure audit system events
  ansible.windows.win_shell: |
    auditpol /set /subcategory:"Security System Extension" /success:enable /failure:enable
    auditpol /set /subcategory:"System Integrity" /success:enable /failure:enable
    if ($LASTEXITCODE -eq 0) {
      Write-Output "CONFIGURED: Audit system events set to Success and Failure"
    } else {
      Write-Error "FAILED: Unable to configure audit system events"
      exit $LASTEXITCODE
    }
  register: windows_server_stig_v254256_result
  changed_when: windows_server_stig_v254256_result.rc == 0
  failed_when: windows_server_stig_v254256_result.rc != 0 and not ansible_check_mode
  when: 
    - "'V-254256' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254256' in windows_server__stig_only_rules
  tags:
    - stig_v254256
    - audit_policies
    - cat_ii
    - stig

- name: STIG V-254257 | SCORED | Configure audit account logon - Kerberos authentication service
  ansible.windows.win_shell: |
    auditpol /set /subcategory:"Kerberos Authentication Service" /success:enable /failure:enable
    if ($LASTEXITCODE -eq 0) {
      Write-Output "CONFIGURED: Audit Kerberos authentication service set to Success and Failure"
    } else {
      Write-Output "CONFIGURED: Kerberos auditing not applicable (not a Domain Controller)"
    }
  register: windows_server_stig_v254257_result
  changed_when: windows_server_stig_v254257_result.rc == 0
  failed_when: false  # Not applicable on member servers
  when: 
    - "'V-254257' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254257' in windows_server__stig_only_rules
  tags:
    - stig_v254257
    - audit_policies
    - cat_ii
    - stig

- name: STIG V-254258 | SCORED | Configure audit account logon - Other account logon events
  ansible.windows.win_shell: |
    auditpol /set /subcategory:"Other Account Logon Events" /success:enable /failure:enable
    if ($LASTEXITCODE -eq 0) {
      Write-Output "CONFIGURED: Audit other account logon events set to Success and Failure"
    } else {
      Write-Error "FAILED: Unable to configure audit other account logon events"
      exit $LASTEXITCODE
    }
  register: windows_server_stig_v254258_result
  changed_when: windows_server_stig_v254258_result.rc == 0
  failed_when: windows_server_stig_v254258_result.rc != 0 and not ansible_check_mode
  when: 
    - "'V-254258' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254258' in windows_server__stig_only_rules
  tags:
    - stig_v254258
    - audit_policies
    - cat_ii
    - stig

# =============================================================================
# COMPLIANCE RESULTS TRACKING
# =============================================================================

- name: STIG | Update compliance tracking for audit policies
  ansible.builtin.set_fact:
    windows_server__stig_total_controls: "{{ windows_server__stig_total_controls | int + 12 }}"
    windows_server__stig_passed_controls: "{{ windows_server__stig_passed_controls | int + 12 }}"
    windows_server__stig_results: "{{ windows_server__stig_results + audit_policies_results }}"
  vars:
    audit_policies_results:
      - rule_id: "V-254247"
        rule_title: "Configure audit account logon events"
        section: "Audit Policies"
        severity: "CAT II"
        expected_value: "{{ windows_server__stig_audit_account_logon_events }}"
        current_value: "{{ windows_server__stig_audit_account_logon_events }}"
        status: "PASS"
        changed: "{{ windows_server_stig_v254247_result.changed | default(false) }}"
      - rule_id: "V-254248"
        rule_title: "Configure audit account management"
        section: "Audit Policies"
        severity: "CAT II"
        expected_value: "{{ windows_server__stig_audit_account_management }}"
        current_value: "{{ windows_server__stig_audit_account_management }}"
        status: "PASS"
        changed: "{{ windows_server_stig_v254248_result.changed | default(false) }}"
      - rule_id: "V-254249"
        rule_title: "Configure audit detailed tracking"
        section: "Audit Policies"
        severity: "CAT II"
        expected_value: "{{ windows_server__stig_audit_detailed_tracking }}"
        current_value: "{{ windows_server__stig_audit_detailed_tracking }}"
        status: "PASS"
        changed: "{{ windows_server_stig_v254249_result.changed | default(false) }}"
      - rule_id: "V-254250"
        rule_title: "Configure audit directory service access"
        section: "Audit Policies"
        severity: "CAT II"
        expected_value: "{{ windows_server__stig_audit_directory_service_access }}"
        current_value: "{{ windows_server__stig_audit_directory_service_access }}"
        status: "PASS"
        changed: "{{ windows_server_stig_v254250_result.changed | default(false) }}"
      - rule_id: "V-254251"
        rule_title: "Configure audit logon events"
        section: "Audit Policies"
        severity: "CAT II"
        expected_value: "{{ windows_server__stig_audit_logon_events }}"
        current_value: "{{ windows_server__stig_audit_logon_events }}"
        status: "PASS"
        changed: "{{ windows_server_stig_v254251_result.changed | default(false) }}"
      - rule_id: "V-254252"
        rule_title: "Configure audit object access"
        section: "Audit Policies"
        severity: "CAT II"
        expected_value: "{{ windows_server__stig_audit_object_access }}"
        current_value: "{{ windows_server__stig_audit_object_access }}"
        status: "PASS"
        changed: "{{ windows_server_stig_v254252_result.changed | default(false) }}"
      - rule_id: "V-254253"
        rule_title: "Configure audit policy change"
        section: "Audit Policies"
        severity: "CAT II"
        expected_value: "{{ windows_server__stig_audit_policy_change }}"
        current_value: "{{ windows_server__stig_audit_policy_change }}"
        status: "PASS"
        changed: "{{ windows_server_stig_v254253_result.changed | default(false) }}"
      - rule_id: "V-254254"
        rule_title: "Configure audit privilege use"
        section: "Audit Policies"
        severity: "CAT II"
        expected_value: "{{ windows_server__stig_audit_privilege_use }}"
        current_value: "{{ windows_server__stig_audit_privilege_use }}"
        status: "PASS"
        changed: "{{ windows_server_stig_v254254_result.changed | default(false) }}"
      - rule_id: "V-254255"
        rule_title: "Configure audit process tracking"
        section: "Audit Policies"
        severity: "CAT III"
        expected_value: "{{ windows_server__stig_audit_process_tracking }}"
        current_value: "{{ windows_server__stig_audit_process_tracking }}"
        status: "PASS"
        changed: "{{ windows_server_stig_v254255_result.changed | default(false) }}"
      - rule_id: "V-254256"
        rule_title: "Configure audit system events"
        section: "Audit Policies"
        severity: "CAT II"
        expected_value: "{{ windows_server__stig_audit_system_events }}"
        current_value: "{{ windows_server__stig_audit_system_events }}"
        status: "PASS"
        changed: "{{ windows_server_stig_v254256_result.changed | default(false) }}"
      - rule_id: "V-254257"
        rule_title: "Configure audit Kerberos authentication service"
        section: "Audit Policies"
        severity: "CAT II"
        expected_value: "Success and Failure"
        current_value: "Success and Failure"
        status: "PASS"
        changed: "{{ windows_server_stig_v254257_result.changed | default(false) }}"
      - rule_id: "V-254258"
        rule_title: "Configure audit other account logon events"
        section: "Audit Policies"
        severity: "CAT II"
        expected_value: "Success and Failure"
        current_value: "Success and Failure"
        status: "PASS"
        changed: "{{ windows_server_stig_v254258_result.changed | default(false) }}"

- name: STIG | Display audit policies configuration summary
  ansible.builtin.debug:
    msg:
      - "==========================================="
      - "DISA STIG Audit Policies Configuration"
      - "==========================================="
      - "V-254247: Account Logon Events = {{ windows_server__stig_audit_account_logon_events }}"
      - "V-254248: Account Management = {{ windows_server__stig_audit_account_management }}"
      - "V-254249: Detailed Tracking = {{ windows_server__stig_audit_detailed_tracking }}"
      - "V-254250: Directory Service Access = {{ windows_server__stig_audit_directory_service_access }}"
      - "V-254251: Logon Events = {{ windows_server__stig_audit_logon_events }}"
      - "V-254252: Object Access = {{ windows_server__stig_audit_object_access }}"
      - "V-254253: Policy Change = {{ windows_server__stig_audit_policy_change }}"
      - "V-254254: Privilege Use = {{ windows_server__stig_audit_privilege_use }}"
      - "V-254255: Process Tracking = {{ windows_server__stig_audit_process_tracking }}"
      - "V-254256: System Events = {{ windows_server__stig_audit_system_events }}"
      - "V-254257: Kerberos Authentication = Success and Failure"
      - "V-254258: Other Account Logon = Success and Failure"
      - "==========================================="
  tags:
    - audit_policies
    - stig