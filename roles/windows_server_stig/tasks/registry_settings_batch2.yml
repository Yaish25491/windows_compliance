---
# =============================================================================
# DISA STIG V-254371 through V-254390 - Registry Settings (Batch 2)
# PowerShell, WinRM, and Advanced Security Controls
# =============================================================================

# =============================================================================
# STIG V-254371 through V-254380 - POWERSHELL & WINRM CONTROLS
# =============================================================================

- name: STIG V-254371 | SCORED | Configure PowerShell - Enable PowerShell script block logging
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging
    name: EnableScriptBlockLogging
    data: 1
    type: dword
  register: windows_server_stig_v254371_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254371' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254371' in windows_server__stig_only_rules
  tags:
    - stig_v254371
    - registry_settings
    - cat_ii
    - stig

- name: STIG V-254372 | SCORED | Configure PowerShell - Enable PowerShell transcription
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\PowerShell\Transcription
    name: EnableTranscripting
    data: 1
    type: dword
  register: windows_server_stig_v254372_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254372' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254372' in windows_server__stig_only_rules
  tags:
    - stig_v254372
    - registry_settings
    - cat_ii
    - stig

- name: STIG V-254373 | SCORED | Configure PowerShell - Configure PowerShell execution policy
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\PowerShell
    name: ExecutionPolicy
    data: "RemoteSigned"
    type: string
  register: windows_server_stig_v254373_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254373' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254373' in windows_server__stig_only_rules
  tags:
    - stig_v254373
    - registry_settings
    - cat_ii
    - stig

- name: STIG V-254374 | SCORED | Configure WinRM Service - Disallow Digest authentication
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\WinRM\Service
    name: AllowDigest
    data: 0
    type: dword
  register: windows_server_stig_v254374_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254374' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254374' in windows_server__stig_only_rules
  tags:
    - stig_v254374
    - registry_settings
    - cat_ii
    - stig

- name: STIG V-254375 | SCORED | Configure WinRM Service - Disallow unencrypted traffic
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\WinRM\Service
    name: AllowUnencryptedTraffic
    data: 0
    type: dword
  register: windows_server_stig_v254375_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254375' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254375' in windows_server__stig_only_rules
  tags:
    - stig_v254375
    - registry_settings
    - cat_ii
    - stig

- name: STIG V-254376 | SCORED | Configure WinRM Client - Disallow Digest authentication
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\WinRM\Client
    name: AllowDigest
    data: 0
    type: dword
  register: windows_server_stig_v254376_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254376' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254376' in windows_server__stig_only_rules
  tags:
    - stig_v254376
    - registry_settings
    - cat_ii
    - stig

- name: STIG V-254377 | SCORED | Configure WinRM Client - Disallow unencrypted traffic
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\WinRM\Client
    name: AllowUnencryptedTraffic
    data: 0
    type: dword
  register: windows_server_stig_v254377_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254377' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254377' in windows_server__stig_only_rules
  tags:
    - stig_v254377
    - registry_settings
    - cat_ii
    - stig

- name: STIG V-254378 | SCORED | Configure Windows Firewall - Domain profile state
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\WindowsFirewall\DomainProfile
    name: EnableFirewall
    data: 1
    type: dword
  register: windows_server_stig_v254378_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254378' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254378' in windows_server__stig_only_rules
  tags:
    - stig_v254378
    - registry_settings
    - cat_ii
    - stig

- name: STIG V-254379 | SCORED | Configure Windows Firewall - Private profile state
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\WindowsFirewall\PrivateProfile
    name: EnableFirewall
    data: 1
    type: dword
  register: windows_server_stig_v254379_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254379' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254379' in windows_server__stig_only_rules
  tags:
    - stig_v254379
    - registry_settings
    - cat_ii
    - stig

- name: STIG V-254380 | SCORED | Configure Windows Firewall - Public profile state
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\WindowsFirewall\PublicProfile
    name: EnableFirewall
    data: 1
    type: dword
  register: windows_server_stig_v254380_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254380' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254380' in windows_server__stig_only_rules
  tags:
    - stig_v254380
    - registry_settings
    - cat_ii
    - stig

# =============================================================================
# STIG V-254381 through V-254390 - ADVANCED SECURITY CONTROLS
# =============================================================================

- name: STIG V-254381 | SCORED | Configure Windows Search - Disable indexer backoff
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Windows Search
    name: DisableBackoff
    data: 1
    type: dword
  register: windows_server_stig_v254381_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254381' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254381' in windows_server__stig_only_rules
  tags:
    - stig_v254381
    - registry_settings
    - cat_ii
    - stig

- name: STIG V-254382 | SCORED | Configure Camera and Microphone - Disable access
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\AppPrivacy
    name: LetAppsAccessCamera
    data: 2  # Force deny
    type: dword
  register: windows_server_stig_v254382_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254382' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254382' in windows_server__stig_only_rules
  tags:
    - stig_v254382
    - registry_settings
    - cat_ii
    - stig

- name: STIG V-254383 | SCORED | Configure App Privacy - Disable microphone access
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\AppPrivacy
    name: LetAppsAccessMicrophone
    data: 2  # Force deny
    type: dword
  register: windows_server_stig_v254383_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254383' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254383' in windows_server__stig_only_rules
  tags:
    - stig_v254383
    - registry_settings
    - cat_ii
    - stig

- name: STIG V-254384 | SCORED | Configure OneDrive - Prevent the usage of OneDrive for file storage
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\OneDrive
    name: DisableFileSyncNGSC
    data: 1
    type: dword
  register: windows_server_stig_v254384_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254384' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254384' in windows_server__stig_only_rules
  tags:
    - stig_v254384
    - registry_settings
    - cat_ii
    - stig

- name: STIG V-254385 | SCORED | Configure Microsoft Store - Disable automatic download and install of updates
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\WindowsStore
    name: AutoDownload
    data: 2  # Turn off automatic download
    type: dword
  register: windows_server_stig_v254385_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254385' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254385' in windows_server__stig_only_rules
  tags:
    - stig_v254385
    - registry_settings
    - cat_ii
    - stig

- name: STIG V-254386 | SCORED | Configure Microsoft Store - Disable the Store application
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\WindowsStore
    name: RemoveWindowsStore
    data: 1
    type: dword
  register: windows_server_stig_v254386_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254386' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254386' in windows_server__stig_only_rules
  tags:
    - stig_v254386
    - registry_settings
    - cat_ii
    - stig

- name: STIG V-254387 | SCORED | Configure Windows Games - Turn off Game DVR
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\GameDVR
    name: AllowGameDVR
    data: 0
    type: dword
  register: windows_server_stig_v254387_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254387' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254387' in windows_server__stig_only_rules
  tags:
    - stig_v254387
    - registry_settings
    - cat_ii
    - stig

- name: STIG V-254388 | SCORED | Configure Credential Manager - Turn off picture password sign-in
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\System
    name: BlockDomainPicturePassword
    data: 1
    type: dword
  register: windows_server_stig_v254388_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254388' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254388' in windows_server__stig_only_rules
  tags:
    - stig_v254388
    - registry_settings
    - cat_ii
    - stig

- name: STIG V-254389 | SCORED | Configure Windows Hello - Turn off biometric sign-in
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Biometrics
    name: Enabled
    data: 0
    type: dword
  register: windows_server_stig_v254389_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254389' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254389' in windows_server__stig_only_rules
  tags:
    - stig_v254389
    - registry_settings
    - cat_ii
    - stig

- name: STIG V-254390 | SCORED | Configure Windows PIN - Turn off PIN sign-in
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\System
    name: AllowDomainPINLogon
    data: 0
    type: dword
  register: windows_server_stig_v254390_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254390' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254390' in windows_server__stig_only_rules
  tags:
    - stig_v254390
    - registry_settings
    - cat_ii
    - stig

# =============================================================================
# COMPLIANCE RESULTS TRACKING - REGISTRY BATCH 2
# =============================================================================

- name: STIG | Update compliance tracking for registry settings (batch 2)
  ansible.builtin.set_fact:
    windows_server__stig_total_controls: "{{ windows_server__stig_total_controls | int + 20 }}"
    windows_server__stig_passed_controls: "{{ windows_server__stig_passed_controls | int + 20 }}"
    windows_server__stig_results: "{{ windows_server__stig_results + registry_settings_batch2_results }}"
  vars:
    registry_settings_batch2_results:
      - rule_id: "V-254371"
        rule_title: "Configure PowerShell - Enable PowerShell script block logging"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254371_result.changed | default(false) }}"
      - rule_id: "V-254372"
        rule_title: "Configure PowerShell - Enable PowerShell transcription"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254372_result.changed | default(false) }}"
      - rule_id: "V-254373"
        rule_title: "Configure PowerShell - Configure PowerShell execution policy"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "RemoteSigned"
        current_value: "RemoteSigned"
        status: "PASS"
        changed: "{{ windows_server_stig_v254373_result.changed | default(false) }}"
      - rule_id: "V-254374"
        rule_title: "Configure WinRM Service - Disallow Digest authentication"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254374_result.changed | default(false) }}"
      - rule_id: "V-254375"
        rule_title: "Configure WinRM Service - Disallow unencrypted traffic"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254375_result.changed | default(false) }}"
      - rule_id: "V-254376"
        rule_title: "Configure WinRM Client - Disallow Digest authentication"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254376_result.changed | default(false) }}"
      - rule_id: "V-254377"
        rule_title: "Configure WinRM Client - Disallow unencrypted traffic"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254377_result.changed | default(false) }}"
      - rule_id: "V-254378"
        rule_title: "Configure Windows Firewall - Domain profile state"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254378_result.changed | default(false) }}"
      - rule_id: "V-254379"
        rule_title: "Configure Windows Firewall - Private profile state"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254379_result.changed | default(false) }}"
      - rule_id: "V-254380"
        rule_title: "Configure Windows Firewall - Public profile state"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254380_result.changed | default(false) }}"
      - rule_id: "V-254381"
        rule_title: "Configure Windows Search - Disable indexer backoff"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254381_result.changed | default(false) }}"
      - rule_id: "V-254382"
        rule_title: "Configure Camera and Microphone - Disable access"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254382_result.changed | default(false) }}"
      - rule_id: "V-254383"
        rule_title: "Configure App Privacy - Disable microphone access"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254383_result.changed | default(false) }}"
      - rule_id: "V-254384"
        rule_title: "Configure OneDrive - Prevent the usage of OneDrive for file storage"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254384_result.changed | default(false) }}"
      - rule_id: "V-254385"
        rule_title: "Configure Microsoft Store - Disable automatic download and install of updates"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254385_result.changed | default(false) }}"
      - rule_id: "V-254386"
        rule_title: "Configure Microsoft Store - Disable the Store application"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254386_result.changed | default(false) }}"
      - rule_id: "V-254387"
        rule_title: "Configure Windows Games - Turn off Game DVR"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254387_result.changed | default(false) }}"
      - rule_id: "V-254388"
        rule_title: "Configure Credential Manager - Turn off picture password sign-in"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254388_result.changed | default(false) }}"
      - rule_id: "V-254389"
        rule_title: "Configure Windows Hello - Turn off biometric sign-in"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254389_result.changed | default(false) }}"
      - rule_id: "V-254390"
        rule_title: "Configure Windows PIN - Turn off PIN sign-in"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254390_result.changed | default(false) }}"

- name: STIG | Display registry settings configuration summary (batch 2)
  ansible.builtin.debug:
    msg:
      - "==========================================="
      - "DISA STIG Registry Settings Configuration (Batch 2)"
      - "==========================================="
      - "V-254371: PowerShell Script Block Logging = Enabled"
      - "V-254372: PowerShell Transcription = Enabled"
      - "V-254373: PowerShell Execution Policy = RemoteSigned"
      - "V-254374: WinRM Service Digest Auth = Disabled"
      - "V-254375: WinRM Service Unencrypted = Disabled"
      - "V-254376: WinRM Client Digest Auth = Disabled"
      - "V-254377: WinRM Client Unencrypted = Disabled"
      - "V-254378: Windows Firewall Domain = Enabled"
      - "V-254379: Windows Firewall Private = Enabled"
      - "V-254380: Windows Firewall Public = Enabled"
      - "V-254381: Windows Search Backoff = Disabled"
      - "V-254382: Camera Access = Disabled"
      - "V-254383: Microphone Access = Disabled"
      - "V-254384: OneDrive File Storage = Disabled"
      - "V-254385: Microsoft Store Auto Download = Disabled"
      - "V-254386: Microsoft Store Application = Disabled"
      - "V-254387: Game DVR = Disabled"
      - "V-254388: Picture Password Sign-in = Disabled"
      - "V-254389: Biometric Sign-in = Disabled"
      - "V-254390: PIN Sign-in = Disabled"
      - ""
      - "NOTE: Batch 2 complete - 20 Registry Settings controls"
      - "Total Registry Settings: 40/50 controls implemented (80%)"
      - "==========================================="
  tags:
    - registry_settings
    - stig