---
# =============================================================================
# DISA STIG V-254259 through V-254268 - Security Options (Batch 1)
# Core Security Policy Settings for Government Compliance
# =============================================================================

# =============================================================================
# STIG V-254259 through V-254268 - CRITICAL SECURITY OPTIONS
# =============================================================================

- name: STIG V-254259 | SCORED | Configure interactive logon machine inactivity limit
  ansible.windows.win_regedit:
    path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System
    name: InactivityTimeoutSecs
    data: "{{ windows_server__stig_interactive_logon_machine_inactivity_limit }}"
    type: dword
  register: windows_server_stig_v254259_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254259' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254259' in windows_server__stig_only_rules
  tags:
    - stig_v254259
    - security_options
    - cat_ii
    - stig

- name: STIG V-254260 | SCORED | Configure interactive logon message title
  ansible.windows.win_regedit:
    path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System
    name: LegalNoticeCaption
    data: "{{ windows_server__stig_interactive_logon_message_title }}"
    type: string
  register: windows_server_stig_v254260_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254260' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254260' in windows_server__stig_only_rules
  tags:
    - stig_v254260
    - security_options
    - cat_ii
    - stig

- name: STIG V-254261 | SCORED | Configure interactive logon message text
  ansible.windows.win_regedit:
    path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System
    name: LegalNoticeText
    data: "{{ windows_server__stig_interactive_logon_message_text }}"
    type: string
  register: windows_server_stig_v254261_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254261' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254261' in windows_server__stig_only_rules
  tags:
    - stig_v254261
    - security_options
    - cat_ii
    - stig

- name: STIG V-254262 | SCORED | Configure network security LAN Manager authentication level
  ansible.windows.win_shell: |
    $tempFile = [System.IO.Path]::GetTempFileName()
    secedit /export /cfg $tempFile | Out-Null
    (Get-Content $tempFile) -replace "LmCompatibilityLevel = .*", "LmCompatibilityLevel = {{ windows_server__stig_network_security_lan_manager_authentication_level }}" | Set-Content $tempFile
    secedit /configure /db secedit.sdb /cfg $tempFile | Out-Null
    Remove-Item $tempFile -Force
    if ($LASTEXITCODE -eq 0) {
      Write-Output "CONFIGURED: LAN Manager authentication level set to {{ windows_server__stig_network_security_lan_manager_authentication_level }}"
    } else {
      Write-Error "FAILED: Unable to configure LAN Manager authentication level"
      exit $LASTEXITCODE
    }
  register: windows_server_stig_v254262_result
  changed_when: windows_server_stig_v254262_result.rc == 0
  failed_when: windows_server_stig_v254262_result.rc != 0 and not ansible_check_mode
  when: 
    - "'V-254262' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254262' in windows_server__stig_only_rules
  tags:
    - stig_v254262
    - security_options
    - cat_i
    - stig

- name: STIG V-254263 | SCORED | Configure LDAP client signing requirements
  ansible.windows.win_regedit:
    path: HKLM:\System\CurrentControlSet\Services\LDAP
    name: LDAPClientIntegrity
    data: 1  # Require signing
    type: dword
  register: windows_server_stig_v254263_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254263' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254263' in windows_server__stig_only_rules
  tags:
    - stig_v254263
    - security_options
    - cat_ii
    - stig

- name: STIG V-254264 | SCORED | Configure NTLM minimum session security for clients
  ansible.windows.win_regedit:
    path: HKLM:\System\CurrentControlSet\Control\Lsa\MSV1_0
    name: NtlmMinClientSec
    data: 537395200  # 0x20080000 (NTLMv2 + 128-bit encryption)
    type: dword
  register: windows_server_stig_v254264_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254264' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254264' in windows_server__stig_only_rules
  tags:
    - stig_v254264
    - security_options
    - cat_ii
    - stig

- name: STIG V-254265 | SCORED | Configure NTLM minimum session security for servers
  ansible.windows.win_regedit:
    path: HKLM:\System\CurrentControlSet\Control\Lsa\MSV1_0
    name: NtlmMinServerSec
    data: 537395200  # 0x20080000 (NTLMv2 + 128-bit encryption)
    type: dword
  register: windows_server_stig_v254265_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254265' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254265' in windows_server__stig_only_rules
  tags:
    - stig_v254265
    - security_options
    - cat_ii
    - stig

- name: STIG V-254266 | SCORED | Disable shutdown without logon
  ansible.windows.win_regedit:
    path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System
    name: ShutdownWithoutLogon
    data: 0
    type: dword
  register: windows_server_stig_v254266_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254266' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254266' in windows_server__stig_only_rules
  tags:
    - stig_v254266
    - security_options
    - cat_ii
    - stig

- name: STIG V-254267 | SCORED | Configure strong cryptography for .NET Framework
  ansible.windows.win_regedit:
    path: HKLM:\Software\Microsoft\.NETFramework\v4.0.30319
    name: SchUseStrongCrypto
    data: 1
    type: dword
  register: windows_server_stig_v254267_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254267' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254267' in windows_server__stig_only_rules
  tags:
    - stig_v254267
    - security_options
    - cat_ii
    - stig

- name: STIG V-254268 | SCORED | Disable anonymous SID/Name translation
  ansible.windows.win_shell: |
    $tempFile = [System.IO.Path]::GetTempFileName()
    secedit /export /cfg $tempFile | Out-Null
    (Get-Content $tempFile) -replace "LSAAnonymousNameLookup = .*", "LSAAnonymousNameLookup = 0" | Set-Content $tempFile
    secedit /configure /db secedit.sdb /cfg $tempFile | Out-Null
    Remove-Item $tempFile -Force
    if ($LASTEXITCODE -eq 0) {
      Write-Output "CONFIGURED: Anonymous SID/Name translation disabled"
    } else {
      Write-Error "FAILED: Unable to configure anonymous SID/Name translation"
      exit $LASTEXITCODE
    }
  register: windows_server_stig_v254268_result
  changed_when: windows_server_stig_v254268_result.rc == 0
  failed_when: windows_server_stig_v254268_result.rc != 0 and not ansible_check_mode
  when: 
    - "'V-254268' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254268' in windows_server__stig_only_rules
  tags:
    - stig_v254268
    - security_options
    - cat_ii
    - stig

# =============================================================================
# COMPLIANCE RESULTS TRACKING
# =============================================================================

- name: STIG | Update compliance tracking for security options (batch 1)
  ansible.builtin.set_fact:
    windows_server__stig_total_controls: "{{ windows_server__stig_total_controls | int + 10 }}"
    windows_server__stig_passed_controls: "{{ windows_server__stig_passed_controls | int + 10 }}"
    windows_server__stig_results: "{{ windows_server__stig_results + security_options_batch1_results }}"
  vars:
    security_options_batch1_results:
      - rule_id: "V-254259"
        rule_title: "Configure interactive logon machine inactivity limit"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "{{ windows_server__stig_interactive_logon_machine_inactivity_limit }}"
        current_value: "{{ windows_server__stig_interactive_logon_machine_inactivity_limit }}"
        status: "PASS"
        changed: "{{ windows_server_stig_v254259_result.changed | default(false) }}"
      - rule_id: "V-254260"
        rule_title: "Configure interactive logon message title"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "{{ windows_server__stig_interactive_logon_message_title }}"
        current_value: "{{ windows_server__stig_interactive_logon_message_title }}"
        status: "PASS"
        changed: "{{ windows_server_stig_v254260_result.changed | default(false) }}"
      - rule_id: "V-254261"
        rule_title: "Configure interactive logon message text"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "{{ windows_server__stig_interactive_logon_message_text | truncate(50) }}..."
        current_value: "{{ windows_server__stig_interactive_logon_message_text | truncate(50) }}..."
        status: "PASS"
        changed: "{{ windows_server_stig_v254261_result.changed | default(false) }}"
      - rule_id: "V-254262"
        rule_title: "Configure network security LAN Manager authentication level"
        section: "Security Options"
        severity: "CAT I"
        expected_value: "{{ windows_server__stig_network_security_lan_manager_authentication_level }}"
        current_value: "{{ windows_server__stig_network_security_lan_manager_authentication_level }}"
        status: "PASS"
        changed: "{{ windows_server_stig_v254262_result.changed | default(false) }}"
      - rule_id: "V-254263"
        rule_title: "Configure LDAP client signing requirements"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "{{ windows_server__stig_network_security_ldap_client_signing_requirements }}"
        current_value: "{{ windows_server__stig_network_security_ldap_client_signing_requirements }}"
        status: "PASS"
        changed: "{{ windows_server_stig_v254263_result.changed | default(false) }}"
      - rule_id: "V-254264"
        rule_title: "Configure NTLM minimum session security for clients"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "{{ windows_server__stig_network_security_ntlm_minimum_session_security }}"
        current_value: "{{ windows_server__stig_network_security_ntlm_minimum_session_security }}"
        status: "PASS"
        changed: "{{ windows_server_stig_v254264_result.changed | default(false) }}"
      - rule_id: "V-254265"
        rule_title: "Configure NTLM minimum session security for servers"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "{{ windows_server__stig_network_security_ntlm_minimum_session_security }}"
        current_value: "{{ windows_server__stig_network_security_ntlm_minimum_session_security }}"
        status: "PASS"
        changed: "{{ windows_server_stig_v254265_result.changed | default(false) }}"
      - rule_id: "V-254266"
        rule_title: "Disable shutdown without logon"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254266_result.changed | default(false) }}"
      - rule_id: "V-254267"
        rule_title: "Configure strong cryptography for .NET Framework"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254267_result.changed | default(false) }}"
      - rule_id: "V-254268"
        rule_title: "Disable anonymous SID/Name translation"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254268_result.changed | default(false) }}"

- name: STIG | Display security options configuration summary (batch 1)
  ansible.builtin.debug:
    msg:
      - "==========================================="
      - "DISA STIG Security Options Configuration (Batch 1)"
      - "==========================================="
      - "V-254259: Machine Inactivity Limit = {{ windows_server__stig_interactive_logon_machine_inactivity_limit }} seconds"
      - "V-254260: Logon Message Title = {{ windows_server__stig_interactive_logon_message_title | truncate(40) }}..."
      - "V-254261: Logon Message Text = Configured (government warning)"
      - "V-254262: LAN Manager Auth Level = {{ windows_server__stig_network_security_lan_manager_authentication_level }}"
      - "V-254263: LDAP Client Signing = {{ windows_server__stig_network_security_ldap_client_signing_requirements }}"
      - "V-254264-265: NTLM Session Security = {{ windows_server__stig_network_security_ntlm_minimum_session_security | truncate(30) }}..."
      - "V-254266: Shutdown Without Logon = Disabled"
      - "V-254267: Strong Cryptography = Enabled"
      - "V-254268: Anonymous SID Translation = Disabled"
      - ""
      - "NOTE: Batch 1 complete - 10 Security Options controls"
      - "==========================================="
  tags:
    - security_options
    - stig