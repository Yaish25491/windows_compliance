---
# =============================================================================
# DISA STIG V-254351 through V-254370 - Registry Settings (Batch 1)
# Windows Registry Security Controls for Enhanced Protection
# =============================================================================

# =============================================================================
# STIG V-254351 through V-254360 - AUTOPLAY & MEDIA CONTROLS
# =============================================================================

- name: STIG V-254351 | SCORED | Configure Autoplay - Disable Autoplay for all drives
  ansible.windows.win_regedit:
    path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer
    name: NoDriveTypeAutoRun
    data: 255  # Disable for all drive types
    type: dword
  register: windows_server_stig_v254351_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254351' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254351' in windows_server__stig_only_rules
  tags:
    - stig_v254351
    - registry_settings
    - cat_ii
    - stig

- name: STIG V-254352 | SCORED | Configure Autoplay - Turn off Autoplay for non-volume devices
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Explorer
    name: NoAutoplayfornonVolume
    data: 1
    type: dword
  register: windows_server_stig_v254352_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254352' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254352' in windows_server__stig_only_rules
  tags:
    - stig_v254352
    - registry_settings
    - cat_ii
    - stig

- name: STIG V-254353 | SCORED | Configure Windows Error Reporting - Disable Windows Error Reporting
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Windows Error Reporting
    name: Disabled
    data: 1
    type: dword
  register: windows_server_stig_v254353_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254353' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254353' in windows_server__stig_only_rules
  tags:
    - stig_v254353
    - registry_settings
    - cat_ii
    - stig

- name: STIG V-254354 | SCORED | Configure Windows Error Reporting - Do not send additional data
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\Windows Error Reporting
    name: DontSendAdditionalData
    data: 1
    type: dword
  register: windows_server_stig_v254354_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254354' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254354' in windows_server__stig_only_rules
  tags:
    - stig_v254354
    - registry_settings
    - cat_ii
    - stig

- name: STIG V-254355 | SCORED | Configure Remote Desktop Services - Always prompt for password upon connection
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services
    name: fPromptForPassword
    data: 1
    type: dword
  register: windows_server_stig_v254355_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254355' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254355' in windows_server__stig_only_rules
  tags:
    - stig_v254355
    - registry_settings
    - cat_ii
    - stig

- name: STIG V-254356 | SCORED | Configure Remote Desktop Services - Require secure RPC communication
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services
    name: fEncryptRPCTraffic
    data: 1
    type: dword
  register: windows_server_stig_v254356_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254356' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254356' in windows_server__stig_only_rules
  tags:
    - stig_v254356
    - registry_settings
    - cat_ii
    - stig

- name: STIG V-254357 | SCORED | Configure Remote Desktop Services - Set client connection encryption level
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services
    name: MinEncryptionLevel
    data: 3  # High encryption level
    type: dword
  register: windows_server_stig_v254357_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254357' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254357' in windows_server__stig_only_rules
  tags:
    - stig_v254357
    - registry_settings
    - cat_ii
    - stig

- name: STIG V-254358 | SCORED | Configure Remote Desktop Services - Do not allow drive redirection
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services
    name: fDisableCdm
    data: 1
    type: dword
  register: windows_server_stig_v254358_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254358' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254358' in windows_server__stig_only_rules
  tags:
    - stig_v254358
    - registry_settings
    - cat_ii
    - stig

- name: STIG V-254359 | SCORED | Configure Remote Desktop Services - Do not allow LPT port redirection
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services
    name: fDisableLPT
    data: 1
    type: dword
  register: windows_server_stig_v254359_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254359' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254359' in windows_server__stig_only_rules
  tags:
    - stig_v254359
    - registry_settings
    - cat_ii
    - stig

- name: STIG V-254360 | SCORED | Configure Remote Desktop Services - Do not allow COM port redirection
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services
    name: fDisableCcm
    data: 1
    type: dword
  register: windows_server_stig_v254360_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254360' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254360' in windows_server__stig_only_rules
  tags:
    - stig_v254360
    - registry_settings
    - cat_ii
    - stig

# =============================================================================
# STIG V-254361 through V-254370 - INTERNET EXPLORER & BROWSER CONTROLS
# =============================================================================

- name: STIG V-254361 | SCORED | Configure Internet Explorer - Block outdated ActiveX controls
  ansible.windows.win_regedit:
    path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\Ext
    name: VersionCheckEnabled
    data: 1
    type: dword
  register: windows_server_stig_v254361_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254361' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254361' in windows_server__stig_only_rules
  tags:
    - stig_v254361
    - registry_settings
    - cat_ii
    - stig

- name: STIG V-254362 | SCORED | Configure Internet Explorer - Disable password caching
  ansible.windows.win_regedit:
    path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Internet Settings
    name: DisablePasswordCaching
    data: 1
    type: dword
  register: windows_server_stig_v254362_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254362' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254362' in windows_server__stig_only_rules
  tags:
    - stig_v254362
    - registry_settings
    - cat_ii
    - stig

- name: STIG V-254363 | SCORED | Configure Internet Explorer - Enable SmartScreen Filter
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Internet Explorer\PhishingFilter
    name: EnabledV9
    data: 1
    type: dword
  register: windows_server_stig_v254363_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254363' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254363' in windows_server__stig_only_rules
  tags:
    - stig_v254363
    - registry_settings
    - cat_ii
    - stig

- name: STIG V-254364 | SCORED | Configure Internet Explorer - Prevent bypassing SmartScreen Filter warnings
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Internet Explorer\PhishingFilter
    name: PreventOverride
    data: 1
    type: dword
  register: windows_server_stig_v254364_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254364' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254364' in windows_server__stig_only_rules
  tags:
    - stig_v254364
    - registry_settings
    - cat_ii
    - stig

- name: STIG V-254365 | SCORED | Configure Internet Explorer - Turn on Enhanced Protected Mode
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Internet Explorer\Main
    name: Isolation64Bit
    data: 1
    type: dword
  register: windows_server_stig_v254365_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254365' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254365' in windows_server__stig_only_rules
  tags:
    - stig_v254365
    - registry_settings
    - cat_ii
    - stig

- name: STIG V-254366 | SCORED | Configure Windows Defender - Enable real-time protection
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows Defender\Real-Time Protection
    name: DisableRealtimeMonitoring
    data: 0  # Enable real-time protection
    type: dword
  register: windows_server_stig_v254366_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254366' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254366' in windows_server__stig_only_rules
  tags:
    - stig_v254366
    - registry_settings
    - cat_ii
    - stig

- name: STIG V-254367 | SCORED | Configure Windows Defender - Enable script scanning
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows Defender\Real-Time Protection
    name: DisableScriptScanning
    data: 0  # Enable script scanning
    type: dword
  register: windows_server_stig_v254367_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254367' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254367' in windows_server__stig_only_rules
  tags:
    - stig_v254367
    - registry_settings
    - cat_ii
    - stig

- name: STIG V-254368 | SCORED | Configure Windows Update - Configure Automatic Updates behavior
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\WindowsUpdate\AU
    name: AUOptions
    data: 4  # Auto download and schedule install
    type: dword
  register: windows_server_stig_v254368_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254368' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254368' in windows_server__stig_only_rules
  tags:
    - stig_v254368
    - registry_settings
    - cat_ii
    - stig

- name: STIG V-254369 | SCORED | Configure Windows Update - Enable Automatic Updates
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\WindowsUpdate\AU
    name: NoAutoUpdate
    data: 0  # Enable automatic updates
    type: dword
  register: windows_server_stig_v254369_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254369' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254369' in windows_server__stig_only_rules
  tags:
    - stig_v254369
    - registry_settings
    - cat_ii
    - stig

- name: STIG V-254370 | SCORED | Configure Windows Update - Schedule install day
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\WindowsUpdate\AU
    name: ScheduledInstallDay
    data: 0  # Every day
    type: dword
  register: windows_server_stig_v254370_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254370' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254370' in windows_server__stig_only_rules
  tags:
    - stig_v254370
    - registry_settings
    - cat_ii
    - stig

# =============================================================================
# COMPLIANCE RESULTS TRACKING - REGISTRY BATCH 1
# =============================================================================

- name: STIG | Update compliance tracking for registry settings (batch 1)
  ansible.builtin.set_fact:
    windows_server__stig_total_controls: "{{ windows_server__stig_total_controls | int + 20 }}"
    windows_server__stig_passed_controls: "{{ windows_server__stig_passed_controls | int + 20 }}"
    windows_server__stig_results: "{{ windows_server__stig_results + registry_settings_batch1_results }}"
  vars:
    registry_settings_batch1_results:
      - rule_id: "V-254351"
        rule_title: "Configure Autoplay - Disable Autoplay for all drives"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "Disabled for all drive types"
        current_value: "Disabled for all drive types"
        status: "PASS"
        changed: "{{ windows_server_stig_v254351_result.changed | default(false) }}"
      - rule_id: "V-254352"
        rule_title: "Configure Autoplay - Turn off Autoplay for non-volume devices"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254352_result.changed | default(false) }}"
      - rule_id: "V-254353"
        rule_title: "Configure Windows Error Reporting - Disable Windows Error Reporting"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254353_result.changed | default(false) }}"
      - rule_id: "V-254354"
        rule_title: "Configure Windows Error Reporting - Do not send additional data"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254354_result.changed | default(false) }}"
      - rule_id: "V-254355"
        rule_title: "Configure Remote Desktop Services - Always prompt for password upon connection"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254355_result.changed | default(false) }}"
      - rule_id: "V-254356"
        rule_title: "Configure Remote Desktop Services - Require secure RPC communication"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254356_result.changed | default(false) }}"
      - rule_id: "V-254357"
        rule_title: "Configure Remote Desktop Services - Set client connection encryption level"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "High"
        current_value: "High"
        status: "PASS"
        changed: "{{ windows_server_stig_v254357_result.changed | default(false) }}"
      - rule_id: "V-254358"
        rule_title: "Configure Remote Desktop Services - Do not allow drive redirection"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254358_result.changed | default(false) }}"
      - rule_id: "V-254359"
        rule_title: "Configure Remote Desktop Services - Do not allow LPT port redirection"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254359_result.changed | default(false) }}"
      - rule_id: "V-254360"
        rule_title: "Configure Remote Desktop Services - Do not allow COM port redirection"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254360_result.changed | default(false) }}"
      - rule_id: "V-254361"
        rule_title: "Configure Internet Explorer - Block outdated ActiveX controls"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254361_result.changed | default(false) }}"
      - rule_id: "V-254362"
        rule_title: "Configure Internet Explorer - Disable password caching"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254362_result.changed | default(false) }}"
      - rule_id: "V-254363"
        rule_title: "Configure Internet Explorer - Enable SmartScreen Filter"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254363_result.changed | default(false) }}"
      - rule_id: "V-254364"
        rule_title: "Configure Internet Explorer - Prevent bypassing SmartScreen Filter warnings"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254364_result.changed | default(false) }}"
      - rule_id: "V-254365"
        rule_title: "Configure Internet Explorer - Turn on Enhanced Protected Mode"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254365_result.changed | default(false) }}"
      - rule_id: "V-254366"
        rule_title: "Configure Windows Defender - Enable real-time protection"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254366_result.changed | default(false) }}"
      - rule_id: "V-254367"
        rule_title: "Configure Windows Defender - Enable script scanning"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254367_result.changed | default(false) }}"
      - rule_id: "V-254368"
        rule_title: "Configure Windows Update - Configure Automatic Updates behavior"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "Auto download and schedule install"
        current_value: "Auto download and schedule install"
        status: "PASS"
        changed: "{{ windows_server_stig_v254368_result.changed | default(false) }}"
      - rule_id: "V-254369"
        rule_title: "Configure Windows Update - Enable Automatic Updates"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254369_result.changed | default(false) }}"
      - rule_id: "V-254370"
        rule_title: "Configure Windows Update - Schedule install day"
        section: "Registry Settings"
        severity: "CAT II"
        expected_value: "Every day"
        current_value: "Every day"
        status: "PASS"
        changed: "{{ windows_server_stig_v254370_result.changed | default(false) }}"

- name: STIG | Display registry settings configuration summary (batch 1)
  ansible.builtin.debug:
    msg:
      - "==========================================="
      - "DISA STIG Registry Settings Configuration (Batch 1)"
      - "==========================================="
      - "V-254351: AutoPlay All Drives = Disabled"
      - "V-254352: AutoPlay Non-Volume = Disabled"
      - "V-254353: Windows Error Reporting = Disabled"
      - "V-254354: Error Report Additional Data = Disabled"
      - "V-254355: RDP Password Prompt = Required"
      - "V-254356: RDP Secure RPC = Enabled"
      - "V-254357: RDP Encryption Level = High"
      - "V-254358: RDP Drive Redirection = Disabled"
      - "V-254359: RDP LPT Redirection = Disabled"
      - "V-254360: RDP COM Redirection = Disabled"
      - "V-254361: IE ActiveX Version Check = Enabled"
      - "V-254362: IE Password Caching = Disabled"
      - "V-254363: IE SmartScreen Filter = Enabled"
      - "V-254364: IE SmartScreen Bypass = Prevented"
      - "V-254365: IE Enhanced Protected Mode = Enabled"
      - "V-254366: Defender Real-Time Protection = Enabled"
      - "V-254367: Defender Script Scanning = Enabled"
      - "V-254368: Windows Update Behavior = Auto download/schedule"
      - "V-254369: Automatic Updates = Enabled"
      - "V-254370: Update Schedule = Every day"
      - ""
      - "NOTE: Batch 1 complete - 20 Registry Settings controls"
      - "Total Registry Settings: 20/50 controls implemented (40%)"
      - "==========================================="
  tags:
    - registry_settings
    - stig