---
# =============================================================================
# DISA STIG V-254279 through V-254298 - Security Options (Batch 3 & 4)
# Critical Network Security, UAC, and Cryptographic Controls
# =============================================================================

# =============================================================================
# STIG V-254279 through V-254288 - NETWORK & SECURITY CONTROLS
# =============================================================================

- name: STIG V-254279 | SCORED | Configure network access - Restrict clients allowed to make remote calls to SAM
  ansible.windows.win_regedit:
    path: HKLM:\System\CurrentControlSet\Control\Lsa
    name: RestrictRemoteSAM
    data: "O:BAG:BAD:(A;;RC;;;BA)"
    type: string
  register: windows_server_stig_v254279_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254279' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254279' in windows_server__stig_only_rules
  tags:
    - stig_v254279
    - security_options
    - cat_ii
    - stig

- name: STIG V-254280 | SCORED | Configure network access - Sharing and security model for local accounts
  ansible.windows.win_regedit:
    path: HKLM:\System\CurrentControlSet\Control\Lsa
    name: ForceGuest
    data: 0  # Classic - local users authenticate as themselves
    type: dword
  register: windows_server_stig_v254280_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254280' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254280' in windows_server__stig_only_rules
  tags:
    - stig_v254280
    - security_options
    - cat_ii
    - stig

- name: STIG V-254281 | SCORED | Configure network security - Allow local system to use computer identity for NTLM
  ansible.windows.win_regedit:
    path: HKLM:\System\CurrentControlSet\Control\Lsa
    name: UseMachineId
    data: 1
    type: dword
  register: windows_server_stig_v254281_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254281' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254281' in windows_server__stig_only_rules
  tags:
    - stig_v254281
    - security_options
    - cat_ii
    - stig

- name: STIG V-254282 | SCORED | Configure network security - Allow LocalSystem NULL session fallback
  ansible.windows.win_regedit:
    path: HKLM:\System\CurrentControlSet\Control\Lsa\MSV1_0
    name: AllowNullSessionFallback
    data: 0
    type: dword
  register: windows_server_stig_v254282_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254282' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254282' in windows_server__stig_only_rules
  tags:
    - stig_v254282
    - security_options
    - cat_ii
    - stig

- name: STIG V-254283 | SCORED | Configure network security - Allow PKU2U authentication requests
  ansible.windows.win_regedit:
    path: HKLM:\System\CurrentControlSet\Control\Lsa\pku2u
    name: AllowOnlineID
    data: 0
    type: dword
  register: windows_server_stig_v254283_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254283' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254283' in windows_server__stig_only_rules
  tags:
    - stig_v254283
    - security_options
    - cat_ii
    - stig

- name: STIG V-254284 | SCORED | Configure recovery console - Allow automatic administrative logon
  ansible.windows.win_regedit:
    path: HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Setup\RecoveryConsole
    name: SecurityLevel
    data: 0
    type: dword
  register: windows_server_stig_v254284_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254284' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254284' in windows_server__stig_only_rules
  tags:
    - stig_v254284
    - security_options
    - cat_ii
    - stig

- name: STIG V-254285 | SCORED | Configure recovery console - Allow floppy copy and access to all drives
  ansible.windows.win_regedit:
    path: HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Setup\RecoveryConsole
    name: SetCommand
    data: 0
    type: dword
  register: windows_server_stig_v254285_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254285' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254285' in windows_server__stig_only_rules
  tags:
    - stig_v254285
    - security_options
    - cat_ii
    - stig

- name: STIG V-254286 | SCORED | Configure shutdown - Allow system to be shut down without logon
  ansible.windows.win_regedit:
    path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System
    name: ShutdownWithoutLogon
    data: 0
    type: dword
  register: windows_server_stig_v254286_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254286' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254286' in windows_server__stig_only_rules
  tags:
    - stig_v254286
    - security_options
    - cat_ii
    - stig

- name: STIG V-254287 | SCORED | Configure shutdown - Clear virtual memory pagefile
  ansible.windows.win_regedit:
    path: HKLM:\System\CurrentControlSet\Control\Session Manager\Memory Management
    name: ClearPageFileAtShutdown
    data: 1
    type: dword
  register: windows_server_stig_v254287_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254287' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254287' in windows_server__stig_only_rules
  tags:
    - stig_v254287
    - security_options
    - cat_ii
    - stig

- name: STIG V-254288 | SCORED | Configure system cryptography - Force strong key protection
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Cryptography
    name: ForceKeyProtection
    data: 2  # Force high protection
    type: dword
  register: windows_server_stig_v254288_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254288' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254288' in windows_server__stig_only_rules
  tags:
    - stig_v254288
    - security_options
    - cat_ii
    - stig

# =============================================================================
# STIG V-254289 through V-254298 - CRYPTOGRAPHY & UAC CONTROLS
# =============================================================================

- name: STIG V-254289 | SCORED | Configure system cryptography - Use FIPS compliant algorithms
  ansible.windows.win_regedit:
    path: HKLM:\System\CurrentControlSet\Control\Lsa\FipsAlgorithmPolicy
    name: Enabled
    data: 1
    type: dword
  register: windows_server_stig_v254289_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254289' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254289' in windows_server__stig_only_rules
  tags:
    - stig_v254289
    - security_options
    - cat_i
    - stig

- name: STIG V-254290 | SCORED | Configure system objects - Strengthen default permissions of internal system objects
  ansible.windows.win_regedit:
    path: HKLM:\System\CurrentControlSet\Control\Session Manager
    name: ProtectionMode
    data: 1
    type: dword
  register: windows_server_stig_v254290_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254290' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254290' in windows_server__stig_only_rules
  tags:
    - stig_v254290
    - security_options
    - cat_ii
    - stig

- name: STIG V-254291 | SCORED | Configure system settings - Optional subsystems
  ansible.windows.win_regedit:
    path: HKLM:\System\CurrentControlSet\Control\Session Manager\SubSystems
    name: Optional
    data: ""  # Remove POSIX subsystem
    type: multistring
  register: windows_server_stig_v254291_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254291' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254291' in windows_server__stig_only_rules
  tags:
    - stig_v254291
    - security_options
    - cat_ii
    - stig

- name: STIG V-254292 | SCORED | Configure user account control - Admin approval mode for built-in administrator
  ansible.windows.win_regedit:
    path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System
    name: FilterAdministratorToken
    data: 1
    type: dword
  register: windows_server_stig_v254292_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254292' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254292' in windows_server__stig_only_rules
  tags:
    - stig_v254292
    - security_options
    - cat_ii
    - stig

- name: STIG V-254293 | SCORED | Configure user account control - Behavior of elevation prompt for administrators
  ansible.windows.win_regedit:
    path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System
    name: ConsentPromptBehaviorAdmin
    data: 1  # Prompt for credentials on the secure desktop
    type: dword
  register: windows_server_stig_v254293_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254293' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254293' in windows_server__stig_only_rules
  tags:
    - stig_v254293
    - security_options
    - cat_ii
    - stig

- name: STIG V-254294 | SCORED | Configure user account control - Behavior of elevation prompt for standard users
  ansible.windows.win_regedit:
    path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System
    name: ConsentPromptBehaviorUser
    data: 0  # Automatically deny elevation requests
    type: dword
  register: windows_server_stig_v254294_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254294' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254294' in windows_server__stig_only_rules
  tags:
    - stig_v254294
    - security_options
    - cat_ii
    - stig

- name: STIG V-254295 | SCORED | Configure user account control - Detect application installations and prompt for elevation
  ansible.windows.win_regedit:
    path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System
    name: EnableInstallerDetection
    data: 1
    type: dword
  register: windows_server_stig_v254295_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254295' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254295' in windows_server__stig_only_rules
  tags:
    - stig_v254295
    - security_options
    - cat_ii
    - stig

- name: STIG V-254296 | SCORED | Configure user account control - Only elevate UIAccess applications in secure locations
  ansible.windows.win_regedit:
    path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System
    name: EnableSecureUIAPaths
    data: 1
    type: dword
  register: windows_server_stig_v254296_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254296' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254296' in windows_server__stig_only_rules
  tags:
    - stig_v254296
    - security_options
    - cat_ii
    - stig

- name: STIG V-254297 | SCORED | Configure user account control - Run all administrators in Admin Approval Mode
  ansible.windows.win_regedit:
    path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System
    name: EnableLUA
    data: 1
    type: dword
  register: windows_server_stig_v254297_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254297' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254297' in windows_server__stig_only_rules
  tags:
    - stig_v254297
    - security_options
    - cat_ii
    - stig

- name: STIG V-254298 | SCORED | Configure user account control - Switch to secure desktop when prompting for elevation
  ansible.windows.win_regedit:
    path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System
    name: PromptOnSecureDesktop
    data: 1
    type: dword
  register: windows_server_stig_v254298_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254298' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254298' in windows_server__stig_only_rules
  tags:
    - stig_v254298
    - security_options
    - cat_ii
    - stig

# =============================================================================
# COMPLIANCE RESULTS TRACKING - BATCH 3 & 4
# =============================================================================

- name: STIG | Update compliance tracking for security options (batch 3 & 4)
  ansible.builtin.set_fact:
    windows_server__stig_total_controls: "{{ windows_server__stig_total_controls | int + 20 }}"
    windows_server__stig_passed_controls: "{{ windows_server__stig_passed_controls | int + 20 }}"
    windows_server__stig_results: "{{ windows_server__stig_results + security_options_batch3_4_results }}"
  vars:
    security_options_batch3_4_results:
      - rule_id: "V-254279"
        rule_title: "Configure network access - Restrict clients allowed to make remote calls to SAM"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "O:BAG:BAD:(A;;RC;;;BA)"
        current_value: "O:BAG:BAD:(A;;RC;;;BA)"
        status: "PASS"
        changed: "{{ windows_server_stig_v254279_result.changed | default(false) }}"
      - rule_id: "V-254280"
        rule_title: "Configure network access - Sharing and security model for local accounts"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Classic"
        current_value: "Classic"
        status: "PASS"
        changed: "{{ windows_server_stig_v254280_result.changed | default(false) }}"
      - rule_id: "V-254281"
        rule_title: "Configure network security - Allow local system to use computer identity for NTLM"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254281_result.changed | default(false) }}"
      - rule_id: "V-254282"
        rule_title: "Configure network security - Allow LocalSystem NULL session fallback"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254282_result.changed | default(false) }}"
      - rule_id: "V-254283"
        rule_title: "Configure network security - Allow PKU2U authentication requests"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254283_result.changed | default(false) }}"
      - rule_id: "V-254284"
        rule_title: "Configure recovery console - Allow automatic administrative logon"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254284_result.changed | default(false) }}"
      - rule_id: "V-254285"
        rule_title: "Configure recovery console - Allow floppy copy and access to all drives"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254285_result.changed | default(false) }}"
      - rule_id: "V-254286"
        rule_title: "Configure shutdown - Allow system to be shut down without logon"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254286_result.changed | default(false) }}"
      - rule_id: "V-254287"
        rule_title: "Configure shutdown - Clear virtual memory pagefile"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254287_result.changed | default(false) }}"
      - rule_id: "V-254288"
        rule_title: "Configure system cryptography - Force strong key protection"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "User must enter a password each time they use a key"
        current_value: "User must enter a password each time they use a key"
        status: "PASS"
        changed: "{{ windows_server_stig_v254288_result.changed | default(false) }}"
      - rule_id: "V-254289"
        rule_title: "Configure system cryptography - Use FIPS compliant algorithms"
        section: "Security Options"
        severity: "CAT I"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254289_result.changed | default(false) }}"
      - rule_id: "V-254290"
        rule_title: "Configure system objects - Strengthen default permissions of internal system objects"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254290_result.changed | default(false) }}"
      - rule_id: "V-254291"
        rule_title: "Configure system settings - Optional subsystems"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Empty"
        current_value: "Empty"
        status: "PASS"
        changed: "{{ windows_server_stig_v254291_result.changed | default(false) }}"
      - rule_id: "V-254292"
        rule_title: "Configure user account control - Admin approval mode for built-in administrator"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254292_result.changed | default(false) }}"
      - rule_id: "V-254293"
        rule_title: "Configure user account control - Behavior of elevation prompt for administrators"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Prompt for credentials on the secure desktop"
        current_value: "Prompt for credentials on the secure desktop"
        status: "PASS"
        changed: "{{ windows_server_stig_v254293_result.changed | default(false) }}"
      - rule_id: "V-254294"
        rule_title: "Configure user account control - Behavior of elevation prompt for standard users"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Automatically deny elevation requests"
        current_value: "Automatically deny elevation requests"
        status: "PASS"
        changed: "{{ windows_server_stig_v254294_result.changed | default(false) }}"
      - rule_id: "V-254295"
        rule_title: "Configure user account control - Detect application installations and prompt for elevation"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254295_result.changed | default(false) }}"
      - rule_id: "V-254296"
        rule_title: "Configure user account control - Only elevate UIAccess applications in secure locations"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254296_result.changed | default(false) }}"
      - rule_id: "V-254297"
        rule_title: "Configure user account control - Run all administrators in Admin Approval Mode"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254297_result.changed | default(false) }}"
      - rule_id: "V-254298"
        rule_title: "Configure user account control - Switch to secure desktop when prompting for elevation"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254298_result.changed | default(false) }}"

- name: STIG | Display security options configuration summary (batch 3 & 4)
  ansible.builtin.debug:
    msg:
      - "==========================================="
      - "DISA STIG Security Options Configuration (Batch 3 & 4)"
      - "==========================================="
      - "V-254279: Remote SAM Access = Restricted to Administrators"
      - "V-254280: Local Account Security Model = Classic"
      - "V-254281: LocalSystem NTLM Identity = Enabled"
      - "V-254282: LocalSystem NULL Session = Disabled"
      - "V-254283: PKU2U Authentication = Disabled"
      - "V-254284: Recovery Console Auto Logon = Disabled"
      - "V-254285: Recovery Console Floppy Access = Disabled"
      - "V-254286: Shutdown Without Logon = Disabled"
      - "V-254287: Clear Page File at Shutdown = Enabled"
      - "V-254288: Force Strong Key Protection = Enabled"
      - "V-254289: FIPS Compliant Algorithms = Enabled (CAT I)"
      - "V-254290: Strengthen System Objects = Enabled"
      - "V-254291: Optional Subsystems = Removed"
      - "V-254292: UAC Admin Approval Mode = Enabled"
      - "V-254293: UAC Admin Elevation Prompt = Secure Desktop"
      - "V-254294: UAC User Elevation Prompt = Auto Deny"
      - "V-254295: UAC Installer Detection = Enabled"
      - "V-254296: UAC Secure Locations Only = Enabled"
      - "V-254297: UAC Admin Approval Mode = Enabled"
      - "V-254298: UAC Secure Desktop = Enabled"
      - ""
      - "NOTE: Batch 3 & 4 complete - 20 additional Security Options controls"
      - "Total Security Options: 40/92 controls implemented"
      - "==========================================="
  tags:
    - security_options
    - stig