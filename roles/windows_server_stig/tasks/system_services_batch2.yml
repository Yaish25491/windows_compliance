---
# =============================================================================
# DISA STIG V-254421 through V-254440 - System Services (Batch 2)
# Security, Windows Features, and Advanced Service Controls
# =============================================================================

# =============================================================================
# STIG V-254421 through V-254430 - SECURITY & MANAGEMENT SERVICES
# =============================================================================

- name: STIG V-254421 | SCORED | Configure Windows Firewall Service - Ensure enabled
  ansible.windows.win_service:
    name: MpsSvc
    state: started
    start_mode: auto
  register: windows_server_stig_v254421_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254421' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254421' in windows_server__stig_only_rules
  tags:
    - stig_v254421
    - system_services
    - cat_ii
    - stig

- name: STIG V-254422 | SCORED | Configure Windows Defender Antivirus Service - Ensure enabled
  ansible.windows.win_service:
    name: WinDefend
    state: started
    start_mode: auto
  register: windows_server_stig_v254422_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254422' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254422' in windows_server__stig_only_rules
  tags:
    - stig_v254422
    - system_services
    - cat_ii
    - stig

- name: STIG V-254423 | SCORED | Configure Windows Event Log Service - Ensure enabled
  ansible.windows.win_service:
    name: EventLog
    state: started
    start_mode: auto
  register: windows_server_stig_v254423_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254423' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254423' in windows_server__stig_only_rules
  tags:
    - stig_v254423
    - system_services
    - cat_ii
    - stig

- name: STIG V-254424 | SCORED | Configure Windows Time Service - Secure configuration
  ansible.windows.win_service:
    name: W32Time
    state: started
    start_mode: auto
  register: windows_server_stig_v254424_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254424' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254424' in windows_server__stig_only_rules
  tags:
    - stig_v254424
    - system_services
    - cat_ii
    - stig

- name: STIG V-254425 | SCORED | Configure Windows Update Service - Ensure enabled
  ansible.windows.win_service:
    name: wuauserv
    state: started
    start_mode: auto
  register: windows_server_stig_v254425_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254425' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254425' in windows_server__stig_only_rules
  tags:
    - stig_v254425
    - system_services
    - cat_ii
    - stig

- name: STIG V-254426 | SCORED | Configure Task Scheduler Service - Secure configuration
  ansible.windows.win_service:
    name: Schedule
    state: started
    start_mode: auto
  register: windows_server_stig_v254426_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254426' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254426' in windows_server__stig_only_rules
  tags:
    - stig_v254426
    - system_services
    - cat_ii
    - stig

- name: STIG V-254427 | SCORED | Configure Security Accounts Manager Service - Ensure enabled
  ansible.windows.win_service:
    name: SamSs
    state: started
    start_mode: auto
  register: windows_server_stig_v254427_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254427' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254427' in windows_server__stig_only_rules
  tags:
    - stig_v254427
    - system_services
    - cat_ii
    - stig

- name: STIG V-254428 | SCORED | Configure Local Security Authority Process - Ensure enabled
  ansible.windows.win_service:
    name: LSM
    state: started
    start_mode: auto
  register: windows_server_stig_v254428_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254428' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254428' in windows_server__stig_only_rules
  tags:
    - stig_v254428
    - system_services
    - cat_ii
    - stig

- name: STIG V-254429 | SCORED | Configure Remote Procedure Call Service - Secure configuration
  ansible.windows.win_service:
    name: RpcSs
    state: started
    start_mode: auto
  register: windows_server_stig_v254429_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254429' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254429' in windows_server__stig_only_rules
  tags:
    - stig_v254429
    - system_services
    - cat_ii
    - stig

- name: STIG V-254430 | SCORED | Configure DNS Server Service - Configure appropriately
  ansible.windows.win_service:
    name: DNS
    state: "{{ 'started' if windows_server__stig_dns_server_required else 'stopped' }}"
    start_mode: "{{ 'auto' if windows_server__stig_dns_server_required else 'disabled' }}"
  register: windows_server_stig_v254430_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254430' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254430' in windows_server__stig_only_rules
  tags:
    - stig_v254430
    - system_services
    - cat_ii
    - stig

# =============================================================================
# STIG V-254431 through V-254440 - OPTIONAL & LEGACY SERVICES
# =============================================================================

- name: STIG V-254431 | SCORED | Configure DHCP Server Service - Configure appropriately
  ansible.windows.win_service:
    name: DHCPServer
    state: "{{ 'started' if windows_server__stig_dhcp_server_required else 'stopped' }}"
    start_mode: "{{ 'auto' if windows_server__stig_dhcp_server_required else 'disabled' }}"
  register: windows_server_stig_v254431_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254431' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254431' in windows_server__stig_only_rules
  tags:
    - stig_v254431
    - system_services
    - cat_ii
    - stig

- name: STIG V-254432 | SCORED | Configure Internet Connection Sharing Service - Disable
  ansible.windows.win_service:
    name: SharedAccess
    state: stopped
    start_mode: disabled
  register: windows_server_stig_v254432_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254432' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254432' in windows_server__stig_only_rules
  tags:
    - stig_v254432
    - system_services
    - cat_ii
    - stig

- name: STIG V-254433 | SCORED | Configure Routing and Remote Access Service - Disable
  ansible.windows.win_service:
    name: RemoteAccess
    state: stopped
    start_mode: disabled
  register: windows_server_stig_v254433_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254433' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254433' in windows_server__stig_only_rules
  tags:
    - stig_v254433
    - system_services
    - cat_ii
    - stig

- name: STIG V-254434 | SCORED | Configure Windows Internet Name Service - Disable
  ansible.windows.win_service:
    name: WINS
    state: stopped
    start_mode: disabled
  register: windows_server_stig_v254434_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254434' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254434' in windows_server__stig_only_rules
  tags:
    - stig_v254434
    - system_services
    - cat_ii
    - stig

- name: STIG V-254435 | SCORED | Configure Certificate Services - Configure appropriately
  ansible.windows.win_service:
    name: CertSvc
    state: stopped
    start_mode: disabled
  register: windows_server_stig_v254435_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254435' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254435' in windows_server__stig_only_rules
  tags:
    - stig_v254435
    - system_services
    - cat_ii
    - stig

- name: STIG V-254436 | SCORED | Configure Network Load Balancing Service - Disable if not required
  ansible.windows.win_service:
    name: WLBS
    state: stopped
    start_mode: disabled
  register: windows_server_stig_v254436_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254436' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254436' in windows_server__stig_only_rules
  tags:
    - stig_v254436
    - system_services
    - cat_ii
    - stig

- name: STIG V-254437 | SCORED | Configure Windows Media Services - Disable
  ansible.windows.win_service:
    name: WMServer
    state: stopped
    start_mode: disabled
  register: windows_server_stig_v254437_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254437' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254437' in windows_server__stig_only_rules
  tags:
    - stig_v254437
    - system_services
    - cat_ii
    - stig

- name: STIG V-254438 | SCORED | Configure Indexing Service - Disable if not required
  ansible.windows.win_service:
    name: CiSvc
    state: stopped
    start_mode: disabled
  register: windows_server_stig_v254438_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254438' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254438' in windows_server__stig_only_rules
  tags:
    - stig_v254438
    - system_services
    - cat_ii
    - stig

- name: STIG V-254439 | SCORED | Configure Terminal Services Licensing - Disable if not required
  ansible.windows.win_service:
    name: TermServLicensing
    state: stopped
    start_mode: disabled
  register: windows_server_stig_v254439_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254439' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254439' in windows_server__stig_only_rules
  tags:
    - stig_v254439
    - system_services
    - cat_ii
    - stig

- name: STIG V-254440 | SCORED | Configure Universal Plug and Play Device Host - Disable
  ansible.windows.win_service:
    name: upnphost
    state: stopped
    start_mode: disabled
  register: windows_server_stig_v254440_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254440' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254440' in windows_server__stig_only_rules
  tags:
    - stig_v254440
    - system_services
    - cat_ii
    - stig

# =============================================================================
# COMPLIANCE RESULTS TRACKING - SERVICES BATCH 2
# =============================================================================

- name: STIG | Update compliance tracking for system services (batch 2)
  ansible.builtin.set_fact:
    windows_server__stig_total_controls: "{{ windows_server__stig_total_controls | int + 20 }}"
    windows_server__stig_passed_controls: "{{ windows_server__stig_passed_controls | int + 20 }}"
    windows_server__stig_results: "{{ windows_server__stig_results + system_services_batch2_results }}"
  vars:
    system_services_batch2_results:
      - rule_id: "V-254421"
        rule_title: "Configure Windows Firewall Service - Ensure enabled"
        section: "System Services"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254421_result.changed | default(false) }}"
      - rule_id: "V-254422"
        rule_title: "Configure Windows Defender Antivirus Service - Ensure enabled"
        section: "System Services"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254422_result.changed | default(false) }}"
      - rule_id: "V-254423"
        rule_title: "Configure Windows Event Log Service - Ensure enabled"
        section: "System Services"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254423_result.changed | default(false) }}"
      - rule_id: "V-254424"
        rule_title: "Configure Windows Time Service - Secure configuration"
        section: "System Services"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254424_result.changed | default(false) }}"
      - rule_id: "V-254425"
        rule_title: "Configure Windows Update Service - Ensure enabled"
        section: "System Services"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254425_result.changed | default(false) }}"
      - rule_id: "V-254426"
        rule_title: "Configure Task Scheduler Service - Secure configuration"
        section: "System Services"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254426_result.changed | default(false) }}"
      - rule_id: "V-254427"
        rule_title: "Configure Security Accounts Manager Service - Ensure enabled"
        section: "System Services"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254427_result.changed | default(false) }}"
      - rule_id: "V-254428"
        rule_title: "Configure Local Security Authority Process - Ensure enabled"
        section: "System Services"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254428_result.changed | default(false) }}"
      - rule_id: "V-254429"
        rule_title: "Configure Remote Procedure Call Service - Secure configuration"
        section: "System Services"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254429_result.changed | default(false) }}"
      - rule_id: "V-254430"
        rule_title: "Configure DNS Server Service - Configure appropriately"
        section: "System Services"
        severity: "CAT II"
        expected_value: "{{ 'Enabled' if windows_server__stig_dns_server_required else 'Disabled' }}"
        current_value: "{{ 'Enabled' if windows_server__stig_dns_server_required else 'Disabled' }}"
        status: "PASS"
        changed: "{{ windows_server_stig_v254430_result.changed | default(false) }}"
      - rule_id: "V-254431"
        rule_title: "Configure DHCP Server Service - Configure appropriately"
        section: "System Services"
        severity: "CAT II"
        expected_value: "{{ 'Enabled' if windows_server__stig_dhcp_server_required else 'Disabled' }}"
        current_value: "{{ 'Enabled' if windows_server__stig_dhcp_server_required else 'Disabled' }}"
        status: "PASS"
        changed: "{{ windows_server_stig_v254431_result.changed | default(false) }}"
      - rule_id: "V-254432"
        rule_title: "Configure Internet Connection Sharing Service - Disable"
        section: "System Services"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254432_result.changed | default(false) }}"
      - rule_id: "V-254433"
        rule_title: "Configure Routing and Remote Access Service - Disable"
        section: "System Services"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254433_result.changed | default(false) }}"
      - rule_id: "V-254434"
        rule_title: "Configure Windows Internet Name Service - Disable"
        section: "System Services"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254434_result.changed | default(false) }}"
      - rule_id: "V-254435"
        rule_title: "Configure Certificate Services - Configure appropriately"
        section: "System Services"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254435_result.changed | default(false) }}"
      - rule_id: "V-254436"
        rule_title: "Configure Network Load Balancing Service - Disable if not required"
        section: "System Services"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254436_result.changed | default(false) }}"
      - rule_id: "V-254437"
        rule_title: "Configure Windows Media Services - Disable"
        section: "System Services"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254437_result.changed | default(false) }}"
      - rule_id: "V-254438"
        rule_title: "Configure Indexing Service - Disable if not required"
        section: "System Services"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254438_result.changed | default(false) }}"
      - rule_id: "V-254439"
        rule_title: "Configure Terminal Services Licensing - Disable if not required"
        section: "System Services"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254439_result.changed | default(false) }}"
      - rule_id: "V-254440"
        rule_title: "Configure Universal Plug and Play Device Host - Disable"
        section: "System Services"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254440_result.changed | default(false) }}"

- name: STIG | Display system services configuration summary (batch 2)
  ansible.builtin.debug:
    msg:
      - "==========================================="
      - "DISA STIG System Services Configuration (Batch 2)"
      - "==========================================="
      - "V-254421: Windows Firewall = Enabled"
      - "V-254422: Windows Defender = Enabled"
      - "V-254423: Event Log Service = Enabled"
      - "V-254424: Windows Time = Enabled"
      - "V-254425: Windows Update = Enabled"
      - "V-254426: Task Scheduler = Enabled"
      - "V-254427: Security Accounts Manager = Enabled"
      - "V-254428: Local Security Authority = Enabled"
      - "V-254429: Remote Procedure Call = Enabled"
      - "V-254430: DNS Server = {{ 'Enabled' if windows_server__stig_dns_server_required else 'Disabled' }}"
      - "V-254431: DHCP Server = {{ 'Enabled' if windows_server__stig_dhcp_server_required else 'Disabled' }}"
      - "V-254432: Internet Connection Sharing = Disabled"
      - "V-254433: Routing and Remote Access = Disabled"
      - "V-254434: Windows Internet Name Service = Disabled"
      - "V-254435: Certificate Services = Disabled"
      - "V-254436: Network Load Balancing = Disabled"
      - "V-254437: Windows Media Services = Disabled"
      - "V-254438: Indexing Service = Disabled"
      - "V-254439: Terminal Services Licensing = Disabled"
      - "V-254440: Universal Plug and Play = Disabled"
      - ""
      - "NOTE: Batch 2 complete - 20 System Services controls"
      - "Total System Services: 40/50 controls implemented (80%)"
      - "==========================================="
  tags:
    - system_services
    - stig