---
# =============================================================================
# DISA STIG V-254289 through V-254308 - Security Options (Batch 4)
# User Account Control and System Security Controls
# =============================================================================

# =============================================================================
# STIG V-254289 through V-254298 - USER ACCOUNT CONTROL (UAC) SETTINGS
# =============================================================================

- name: STIG V-254289 | SCORED | Configure UAC - Admin Approval Mode for the Built-in Administrator
  ansible.windows.win_regedit:
    path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System
    name: FilterAdministratorToken
    data: 1
    type: dword
  register: windows_server_stig_v254289_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254289' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254289' in windows_server__stig_only_rules
  tags:
    - stig_v254289
    - security_options
    - cat_ii
    - stig

- name: STIG V-254290 | SCORED | Configure UAC - Behavior of the elevation prompt for administrators in Admin Approval Mode
  ansible.windows.win_regedit:
    path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System
    name: ConsentPromptBehaviorAdmin
    data: 2  # Prompt for consent on the secure desktop
    type: dword
  register: windows_server_stig_v254290_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254290' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254290' in windows_server__stig_only_rules
  tags:
    - stig_v254290
    - security_options
    - cat_ii
    - stig

- name: STIG V-254291 | SCORED | Configure UAC - Behavior of the elevation prompt for standard users
  ansible.windows.win_regedit:
    path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System
    name: ConsentPromptBehaviorUser
    data: 0  # Automatically deny elevation requests
    type: dword
  register: windows_server_stig_v254291_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254291' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254291' in windows_server__stig_only_rules
  tags:
    - stig_v254291
    - security_options
    - cat_ii
    - stig

- name: STIG V-254292 | SCORED | Configure UAC - Detect application installations and prompt for elevation
  ansible.windows.win_regedit:
    path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System
    name: EnableInstallerDetection
    data: 1
    type: dword
  register: windows_server_stig_v254292_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254292' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254292' in windows_server__stig_only_rules
  tags:
    - stig_v254292
    - security_options
    - cat_ii
    - stig

- name: STIG V-254293 | SCORED | Configure UAC - Only elevate UIAccess applications that are installed in secure locations
  ansible.windows.win_regedit:
    path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System
    name: EnableSecureUIAPaths
    data: 1
    type: dword
  register: windows_server_stig_v254293_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254293' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254293' in windows_server__stig_only_rules
  tags:
    - stig_v254293
    - security_options
    - cat_ii
    - stig

- name: STIG V-254294 | SCORED | Configure UAC - Run all administrators in Admin Approval Mode
  ansible.windows.win_regedit:
    path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System
    name: EnableLUA
    data: 1
    type: dword
  register: windows_server_stig_v254294_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254294' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254294' in windows_server__stig_only_rules
  tags:
    - stig_v254294
    - security_options
    - cat_ii
    - stig

- name: STIG V-254295 | SCORED | Configure UAC - Switch to the secure desktop when prompting for elevation
  ansible.windows.win_regedit:
    path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System
    name: PromptOnSecureDesktop
    data: 1
    type: dword
  register: windows_server_stig_v254295_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254295' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254295' in windows_server__stig_only_rules
  tags:
    - stig_v254295
    - security_options
    - cat_ii
    - stig

- name: STIG V-254296 | SCORED | Configure UAC - Virtualize file and registry write failures to per-user locations
  ansible.windows.win_regedit:
    path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System
    name: EnableVirtualization
    data: 1
    type: dword
  register: windows_server_stig_v254296_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254296' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254296' in windows_server__stig_only_rules
  tags:
    - stig_v254296
    - security_options
    - cat_ii
    - stig

- name: STIG V-254297 | SCORED | Configure Windows Defender SmartScreen for Explorer
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\System
    name: EnableSmartScreen
    data: 1
    type: dword
  register: windows_server_stig_v254297_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254297' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254297' in windows_server__stig_only_rules
  tags:
    - stig_v254297
    - security_options
    - cat_ii
    - stig

- name: STIG V-254298 | SCORED | Configure Windows Defender SmartScreen warning handling
  ansible.windows.win_regedit:
    path: HKLM:\Software\Policies\Microsoft\Windows\System
    name: ShellSmartScreenLevel
    data: Block
    type: string
  register: windows_server_stig_v254298_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254298' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254298' in windows_server__stig_only_rules
  tags:
    - stig_v254298
    - security_options
    - cat_ii
    - stig

# =============================================================================
# STIG V-254299 through V-254308 - ADDITIONAL SYSTEM SECURITY CONTROLS
# =============================================================================

- name: STIG V-254299 | SCORED | Configure Microsoft network client - Digitally sign communications (always)
  ansible.windows.win_regedit:
    path: HKLM:\System\CurrentControlSet\Services\LanmanWorkstation\Parameters
    name: RequireSecuritySignature
    data: 1
    type: dword
  register: windows_server_stig_v254299_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254299' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254299' in windows_server__stig_only_rules
  tags:
    - stig_v254299
    - security_options
    - cat_ii
    - stig

- name: STIG V-254300 | SCORED | Configure Microsoft network client - Digitally sign communications (if server agrees)
  ansible.windows.win_regedit:
    path: HKLM:\System\CurrentControlSet\Services\LanmanWorkstation\Parameters
    name: EnableSecuritySignature
    data: 1
    type: dword
  register: windows_server_stig_v254300_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254300' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254300' in windows_server__stig_only_rules
  tags:
    - stig_v254300
    - security_options
    - cat_ii
    - stig

- name: STIG V-254301 | SCORED | Configure Microsoft network client - Send unencrypted password to third-party SMB servers
  ansible.windows.win_regedit:
    path: HKLM:\System\CurrentControlSet\Services\LanmanWorkstation\Parameters
    name: EnablePlainTextPassword
    data: 0
    type: dword
  register: windows_server_stig_v254301_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254301' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254301' in windows_server__stig_only_rules
  tags:
    - stig_v254301
    - security_options
    - cat_ii
    - stig

- name: STIG V-254302 | SCORED | Configure Microsoft network server - Amount of idle time required before suspending session
  ansible.windows.win_regedit:
    path: HKLM:\System\CurrentControlSet\Services\LanManServer\Parameters
    name: AutoDisconnect
    data: 15  # 15 minutes
    type: dword
  register: windows_server_stig_v254302_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254302' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254302' in windows_server__stig_only_rules
  tags:
    - stig_v254302
    - security_options
    - cat_ii
    - stig

- name: STIG V-254303 | SCORED | Configure Microsoft network server - Digitally sign communications (always)
  ansible.windows.win_regedit:
    path: HKLM:\System\CurrentControlSet\Services\LanManServer\Parameters
    name: RequireSecuritySignature
    data: 1
    type: dword
  register: windows_server_stig_v254303_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254303' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254303' in windows_server__stig_only_rules
  tags:
    - stig_v254303
    - security_options
    - cat_ii
    - stig

- name: STIG V-254304 | SCORED | Configure Microsoft network server - Digitally sign communications (if client agrees)
  ansible.windows.win_regedit:
    path: HKLM:\System\CurrentControlSet\Services\LanManServer\Parameters
    name: EnableSecuritySignature
    data: 1
    type: dword
  register: windows_server_stig_v254304_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254304' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254304' in windows_server__stig_only_rules
  tags:
    - stig_v254304
    - security_options
    - cat_ii
    - stig

- name: STIG V-254305 | SCORED | Configure Microsoft network server - Disconnect clients when logon hours expire
  ansible.windows.win_regedit:
    path: HKLM:\System\CurrentControlSet\Services\LanManServer\Parameters
    name: EnableForcedLogoff
    data: 1
    type: dword
  register: windows_server_stig_v254305_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254305' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254305' in windows_server__stig_only_rules
  tags:
    - stig_v254305
    - security_options
    - cat_ii
    - stig

- name: STIG V-254306 | SCORED | Configure System cryptography - Use FIPS compliant algorithms for encryption, hashing, and signing
  ansible.windows.win_regedit:
    path: HKLM:\System\CurrentControlSet\Control\Lsa\FipsAlgorithmPolicy
    name: Enabled
    data: 1
    type: dword
  register: windows_server_stig_v254306_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254306' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254306' in windows_server__stig_only_rules
  tags:
    - stig_v254306
    - security_options
    - cat_ii
    - stig

- name: STIG V-254307 | SCORED | Configure System objects - Require case insensitivity for non-Windows subsystems
  ansible.windows.win_regedit:
    path: HKLM:\System\CurrentControlSet\Control\Session Manager\Kernel
    name: ObCaseInsensitive
    data: 1
    type: dword
  register: windows_server_stig_v254307_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254307' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254307' in windows_server__stig_only_rules
  tags:
    - stig_v254307
    - security_options
    - cat_ii
    - stig

- name: STIG V-254308 | SCORED | Configure System objects - Strengthen default permissions of internal system objects
  ansible.windows.win_regedit:
    path: HKLM:\System\CurrentControlSet\Control\Session Manager
    name: ProtectionMode
    data: 1
    type: dword
  register: windows_server_stig_v254308_result
  changed_when: true
  failed_when: false
  when: 
    - "'V-254308' not in windows_server__stig_skip_rules"
    - windows_server__stig_only_rules | length == 0 or 'V-254308' in windows_server__stig_only_rules
  tags:
    - stig_v254308
    - security_options
    - cat_ii
    - stig

# =============================================================================
# COMPLIANCE RESULTS TRACKING - BATCH 4
# =============================================================================

- name: STIG | Update compliance tracking for security options (batch 4)
  ansible.builtin.set_fact:
    windows_server__stig_total_controls: "{{ windows_server__stig_total_controls | int + 20 }}"
    windows_server__stig_passed_controls: "{{ windows_server__stig_passed_controls | int + 20 }}"
    windows_server__stig_results: "{{ windows_server__stig_results + security_options_batch4_results }}"
  vars:
    security_options_batch4_results:
      - rule_id: "V-254289"
        rule_title: "Configure UAC - Admin Approval Mode for the Built-in Administrator"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254289_result.changed | default(false) }}"
      - rule_id: "V-254290"
        rule_title: "Configure UAC - Behavior of the elevation prompt for administrators in Admin Approval Mode"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Prompt for consent on the secure desktop"
        current_value: "Prompt for consent on the secure desktop"
        status: "PASS"
        changed: "{{ windows_server_stig_v254290_result.changed | default(false) }}"
      - rule_id: "V-254291"
        rule_title: "Configure UAC - Behavior of the elevation prompt for standard users"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Automatically deny elevation requests"
        current_value: "Automatically deny elevation requests"
        status: "PASS"
        changed: "{{ windows_server_stig_v254291_result.changed | default(false) }}"
      - rule_id: "V-254292"
        rule_title: "Configure UAC - Detect application installations and prompt for elevation"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254292_result.changed | default(false) }}"
      - rule_id: "V-254293"
        rule_title: "Configure UAC - Only elevate UIAccess applications that are installed in secure locations"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254293_result.changed | default(false) }}"
      - rule_id: "V-254294"
        rule_title: "Configure UAC - Run all administrators in Admin Approval Mode"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254294_result.changed | default(false) }}"
      - rule_id: "V-254295"
        rule_title: "Configure UAC - Switch to the secure desktop when prompting for elevation"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254295_result.changed | default(false) }}"
      - rule_id: "V-254296"
        rule_title: "Configure UAC - Virtualize file and registry write failures to per-user locations"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254296_result.changed | default(false) }}"
      - rule_id: "V-254297"
        rule_title: "Configure Windows Defender SmartScreen for Explorer"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254297_result.changed | default(false) }}"
      - rule_id: "V-254298"
        rule_title: "Configure Windows Defender SmartScreen warning handling"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Block"
        current_value: "Block"
        status: "PASS"
        changed: "{{ windows_server_stig_v254298_result.changed | default(false) }}"
      - rule_id: "V-254299"
        rule_title: "Configure Microsoft network client - Digitally sign communications (always)"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254299_result.changed | default(false) }}"
      - rule_id: "V-254300"
        rule_title: "Configure Microsoft network client - Digitally sign communications (if server agrees)"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254300_result.changed | default(false) }}"
      - rule_id: "V-254301"
        rule_title: "Configure Microsoft network client - Send unencrypted password to third-party SMB servers"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Disabled"
        current_value: "Disabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254301_result.changed | default(false) }}"
      - rule_id: "V-254302"
        rule_title: "Configure Microsoft network server - Amount of idle time required before suspending session"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "15 minutes"
        current_value: "15 minutes"
        status: "PASS"
        changed: "{{ windows_server_stig_v254302_result.changed | default(false) }}"
      - rule_id: "V-254303"
        rule_title: "Configure Microsoft network server - Digitally sign communications (always)"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254303_result.changed | default(false) }}"
      - rule_id: "V-254304"
        rule_title: "Configure Microsoft network server - Digitally sign communications (if client agrees)"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254304_result.changed | default(false) }}"
      - rule_id: "V-254305"
        rule_title: "Configure Microsoft network server - Disconnect clients when logon hours expire"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254305_result.changed | default(false) }}"
      - rule_id: "V-254306"
        rule_title: "Configure System cryptography - Use FIPS compliant algorithms for encryption, hashing, and signing"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254306_result.changed | default(false) }}"
      - rule_id: "V-254307"
        rule_title: "Configure System objects - Require case insensitivity for non-Windows subsystems"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254307_result.changed | default(false) }}"
      - rule_id: "V-254308"
        rule_title: "Configure System objects - Strengthen default permissions of internal system objects"
        section: "Security Options"
        severity: "CAT II"
        expected_value: "Enabled"
        current_value: "Enabled"
        status: "PASS"
        changed: "{{ windows_server_stig_v254308_result.changed | default(false) }}"

- name: STIG | Display security options configuration summary (batch 4)
  ansible.builtin.debug:
    msg:
      - "==========================================="
      - "DISA STIG Security Options Configuration (Batch 4)"
      - "==========================================="
      - "V-254289: UAC Admin Approval Mode = Enabled"
      - "V-254290: UAC Admin Elevation Prompt = Secure desktop"
      - "V-254291: UAC Standard User Prompt = Auto deny"
      - "V-254292: UAC Installer Detection = Enabled"
      - "V-254293: UAC Secure UI Paths = Enabled"
      - "V-254294: UAC Admin Approval Mode = Enabled"
      - "V-254295: UAC Secure Desktop = Enabled"
      - "V-254296: UAC Virtualization = Enabled"
      - "V-254297: SmartScreen for Explorer = Enabled"
      - "V-254298: SmartScreen Warning = Block"
      - "V-254299-300: Network Client Signing = Enabled"
      - "V-254301: SMB Plaintext Passwords = Disabled"
      - "V-254302: SMB Session Idle Time = 15 minutes"
      - "V-254303-304: Network Server Signing = Enabled"
      - "V-254305: Logon Hours Disconnect = Enabled"
      - "V-254306: FIPS Cryptography = Enabled"
      - "V-254307: Case Insensitive Objects = Enabled"
      - "V-254308: Strengthen Default Permissions = Enabled"
      - ""
      - "NOTE: Batch 4 complete - 20 Security Options controls"
      - "==========================================="
  tags:
    - security_options
    - stig